<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JIGULUCK: Mega Multiplier Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');

        :root {
            --reel-height: 100px; 
            --symbol-sz: 3rem;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            user-select: none;
            overflow-y: auto;
            min-height: 100vh;
            touch-action: manipulation; 
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.9); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease;
        }

        .bonus-active .glass-panel#game-wrapper {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }

        .slot-window {
            overflow: hidden;
            position: relative;
            z-index: 10;
            mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        }

        .reel-col {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            will-change: transform; 
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .reel-col:last-child { border-right: none; }

        .slot-symbol {
            height: var(--reel-height);
            width: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: var(--symbol-sz);
            line-height: 1;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
            transition: transform 0.2s, filter 0.2s;
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ú–ù–û–ñ–ò–¢–ï–õ–ï–ô --- */
        .mult-x2 {
            color: #60a5fa; /* –ì–æ–ª—É–±–æ–π */
            text-shadow: 0 0 10px rgba(37, 99, 235, 0.8);
            font-weight: 900;
            font-size: calc(var(--symbol-sz) * 0.8);
        }
        .mult-x3 {
            color: #34d399; /* –ó–µ–ª–µ–Ω—ã–π */
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
            font-weight: 900;
            font-size: calc(var(--symbol-sz) * 0.85);
        }
        .mult-x5 {
            color: #ef4444; /* –ö—Ä–∞—Å–Ω—ã–π */
            text-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
            font-weight: 900;
            font-size: calc(var(--symbol-sz) * 0.9);
        }
        .mult-x10 {
            background: linear-gradient(to bottom, #f0abfc, #c084fc); /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 20px rgba(192, 132, 252, 0.9);
            font-weight: 900;
            font-size: calc(var(--symbol-sz) * 1.0);
        }
        
        /* –≠–ü–ò–ß–ï–°–ö–ò–ô x50 */
        @keyframes goldPulse {
            0%, 100% { filter: drop-shadow(0 0 10px #f59e0b); transform: scale(1); }
            50% { filter: drop-shadow(0 0 25px #fbbf24); transform: scale(1.2); }
        }
        .mult-x50 {
            background: linear-gradient(to bottom, #fcd34d, #b45309, #fcd34d);
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
            font-size: calc(var(--symbol-sz) * 1.3);
            animation: goldPulse 1s infinite ease-in-out;
            z-index: 60;
        }

        #paylines-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .payline-path {
            fill: none; 
            stroke-width: 5;
            stroke-linecap: round; 
            stroke-linejoin: round;
            vector-effect: non-scaling-stroke;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8)); 
            stroke-dasharray: 2000; 
            stroke-dashoffset: 2000;
            animation: drawLine 0.5s forwards ease-in-out;
            opacity: 1;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .line-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #60a5fa;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        @keyframes winScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        @keyframes winLightPulse {
            0% { filter: brightness(1) drop-shadow(0 0 0 rgba(255, 215, 0, 0)); }
            50% { filter: brightness(1.8) drop-shadow(0 0 25px rgba(255, 215, 0, 1)); }
            100% { filter: brightness(1) drop-shadow(0 0 0 rgba(255, 215, 0, 0)); }
        }

        .win-anim-scale { animation: winScale 1s infinite ease-in-out; z-index: 10; }
        .win-anim-scale.win-anim-light { animation: winScale 1s infinite ease-in-out, winLightPulse 1s infinite ease-in-out; }
        .win-anim-light { animation: winLightPulse 1s infinite ease-in-out; z-index: 11; }

        @keyframes bombTick {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.3); filter: brightness(2) hue-rotate(-50deg); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .bomb-tick {
            animation: bombTick 0.3s infinite ease-in-out !important;
            z-index: 50;
        }

        @keyframes explosionFlash {
            0% { transform: scale(0.5); filter: brightness(5) sepia(1) saturate(5); opacity: 0; }
            30% { transform: scale(1.2); filter: brightness(3); opacity: 1; }
            100% { transform: scale(1); filter: brightness(1); opacity: 1; }
        }
        .explosion-flash {
            animation: explosionFlash 0.4s ease-out forwards !important;
            z-index: 40;
        }

        /* –¢—Ä—è—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞ */
        @keyframes shake-hard {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .shake-screen {
            animation: shake-hard 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        .spin-btn {
            background: linear-gradient(180deg, #d946ef 0%, #7e22ce 100%);
            box-shadow: 0 6px 0 #581c87, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .spin-btn:active:not(:disabled) { transform: translateY(6px); box-shadow: 0 0 0 #581c87; }
        .spin-btn:disabled { filter: grayscale(1); cursor: not-allowed; transform: translateY(6px); box-shadow: 0 0 0 #581c87; }

        .bonus-active .spin-btn {
            background: linear-gradient(180deg, #fcd34d 0%, #d97706 100%);
            box-shadow: 0 6px 0 #92400e;
            color: #78350f;
        }

        .auto-btn {
            background: linear-gradient(180deg, #475569 0%, #1e293b 100%);
            box-shadow: 0 6px 0 #0f172a, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .auto-btn.active-auto {
            background: linear-gradient(180deg, #22c55e 0%, #15803d 100%);
            box-shadow: 0 6px 0 #14532d;
        }
        .auto-btn:active { transform: translateY(6px); box-shadow: 0 0 0 #0f172a; }
        .auto-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: translateY(6px); box-shadow: none; }

        .modal-backdrop { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .float-text {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: #fbbf24; font-weight: 900; 
            font-size: clamp(2.5rem, 10vw, 5rem);
            text-shadow: 0 4px 0 #000, 0 0 30px rgba(251, 191, 36, 0.5);
            pointer-events: none; z-index: 100; 
            animation: floatPop 1.5s ease-out forwards;
            white-space: nowrap;
        }
        .float-bonus {
            color: #c084fc; 
            text-shadow: 0 4px 0 #000, 0 0 30px rgba(192, 132, 252, 0.6);
            font-size: clamp(1.5rem, 6vw, 3.5rem) !important;
            animation-duration: 3s !important; 
        }
        @keyframes floatPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            15% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
        }

        .bonus-modal-content {
            background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%);
            border: 4px solid #fbbf24;
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.5);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–∏–º–≤–æ–ª–∞ */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .btn-pop-in { animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .symbol-landed { animation: winScale 0.5s forwards; filter: drop-shadow(0 0 20px gold); transform: scale(1.2); }
    </style>
</head>
<body class="w-full min-h-screen bg-gradient-to-b from-slate-950 via-[#1a0b2e] to-slate-900 flex flex-col items-center py-4 text-slate-200">

    <div class="relative z-10 w-full max-w-2xl flex flex-col items-center gap-3 px-2">
        
        <!-- Header -->
        <div class="w-full flex justify-between items-end">
            <div class="glass-panel px-4 py-2 rounded-2xl cursor-pointer hover:bg-white/5 transition group relative" onclick="game.resetBalance()">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–ë–∞–ª–∞–Ω—Å</div>
                <div class="text-2xl font-mono font-bold text-green-400" id="ui-balance">2000</div>
            </div>

            <div class="text-center pb-1">
                <h1 class="text-3xl md:text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 drop-shadow-lg tracking-tighter">
                    JIGU<span class="text-white">LUCK</span>
                </h1>
            </div>

            <div class="glass-panel px-4 py-2 rounded-2xl text-right">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–í—ã–∏–≥—Ä—ã—à</div>
                <div class="text-2xl font-mono font-bold text-yellow-400" id="ui-win">0</div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="glass-panel p-3 md:p-5 rounded-[2rem] w-full shadow-2xl relative transition-colors duration-500" id="game-wrapper">
            
            <div id="bonus-strip" class="hidden absolute -top-4 left-0 w-full flex justify-center z-30">
                 <div class="bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-black px-6 py-1 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] animate-pulse border-2 border-white flex gap-4 items-center text-sm md:text-base">
                    <!-- –°—á–µ—Ç—á–∏–∫ —Å–ø–∏–Ω–æ–≤ -->
                    <span class="flex items-center gap-1">
                        SPINS: <span id="fs-counter" class="text-white drop-shadow-md text-lg">15</span>
                    </span>
                    
                    <div class="w-px h-4 bg-black/20"></div>
                    
                    <!-- –ù–æ–≤—ã–π —Å—á–µ—Ç—á–∏–∫ –≤—ã–∏–≥—Ä—ã—à–∞ -->
                    <span class="flex items-center gap-1">
                        WIN: <span id="bonus-total-display" class="text-white drop-shadow-md text-lg">0</span>
                    </span>

                    <div class="w-px h-4 bg-black/20"></div>

                    <!-- –°–∏–º–≤–æ–ª –±–æ–Ω—É—Å–∞ -->
                    <span id="active-bonus-symbol" class="text-xl leading-none"></span>
                 </div>
            </div>

            <!-- Slot Window -->
            <div class="bg-slate-950 rounded-xl border-4 border-slate-800 shadow-inner relative overflow-hidden mb-4 aspect-[5/3] w-full h-auto">
                <div class="absolute top-0 left-0 w-full h-6 bg-gradient-to-b from-black/70 to-transparent z-20 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-6 bg-gradient-to-t from-black/70 to-transparent z-20 pointer-events-none"></div>
                
                <div class="grid grid-cols-5 h-full w-full relative slot-window" id="slot-machine"></div>
                <svg id="paylines-svg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            </div>

            <!-- Controls -->
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex items-center justify-between">
                        <button class="bet-ctrl w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(-1)">-</button>
                        <div class="text-center">
                            <div class="text-[9px] text-slate-400 uppercase font-bold">–°—Ç–∞–≤–∫–∞</div>
                            <div class="font-mono font-bold text-white text-lg" id="ui-bet">20</div>
                        </div>
                        <button class="bet-ctrl w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(1)">+</button>
                    </div>

                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex flex-col justify-center items-center">
                        <div class="text-[9px] text-slate-400 uppercase font-bold mb-1">–õ–∏–Ω–∏–∏</div>
                        <div class="flex gap-1 w-full justify-between px-1" id="lines-control-panel">
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(1)">1</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(3)">3</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(5)">5</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(7)">7</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(9)">9</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/40 rounded-lg p-2 flex justify-between items-center text-xs font-bold border border-white/5">
                    <span class="text-slate-400">–í–°–ï–ì–û: <span id="ui-total-bet" class="text-white text-sm ml-1">180</span></span>
                    <span id="status-text" class="text-right text-slate-300">–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ!</span>
                </div>

                <div class="flex gap-3 h-16 pb-1">
                    <button id="btn-auto" onclick="game.toggleAuto()" class="w-24 rounded-2xl auto-btn text-xs font-bold flex flex-col items-center justify-center text-slate-300 hover:text-white group">
                        <span class="text-xl mb-1 group-hover:scale-110 transition">üîÑ</span> AUTO
                    </button>
                    
                    <button id="btn-spin" onclick="game.spin()" class="flex-1 rounded-2xl spin-btn text-2xl font-black tracking-[0.2em] text-white text-shadow-sm border-b border-white/20 relative overflow-hidden group">
                        <span class="relative z-10" id="spin-text">SPIN</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="w-full glass-panel p-4 rounded-2xl">
            <h3 class="text-center text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">–¢–∞–±–ª–∏—Ü–∞</h3>
            <div class="grid grid-cols-4 md:grid-cols-9 gap-2" id="legend-grid"></div>
        </div>

    </div>

    <!-- Modals -->
    <div id="win-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop bg-black/80 backdrop-blur-sm" onclick="game.closeWinModal()">
        <div class="text-center transform transition-all scale-110">
            <h2 class="text-5xl font-black text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] mb-2 animate-bounce">–ù–ò–•–£–Ø –°–ï–ë–ï –í–´–ò–ì–†–´–®!</h2>
            <p class="text-6xl font-mono font-bold text-white drop-shadow-lg" id="modal-win-amount">0</p>
            <p class="text-sm text-slate-400 mt-8 uppercase tracking-widest">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å</p>
        </div>
    </div>

    <div id="bonus-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop bg-black/90 backdrop-blur-md">
        <div class="bonus-modal-content p-8 rounded-3xl text-center transform transition-all max-w-md w-full mx-4 relative overflow-hidden min-h-[400px] flex flex-col justify-center" id="bonus-modal-inner">
            <!-- Content filled by JS -->
        </div>
    </div>

    <script>
            const ASSETS = [
                { id: 10, val: 'üåà', payout: 250, weight: 5 }, // WILD (–í–∞–π–ª–¥)
                { id: 9, val: 'üí£', payout: 0, weight: 0 }, 
                { id: 8, val: 'üíé', payout: 0, weight: 8 }, 
                { id: 7, val: 'üëë', payout: 500, weight: 5 },
                { id: 6, val: 'üè∞', payout: 250, weight: 10 },
                { id: 5, val: 'üóùÔ∏è', payout: 100, weight: 15 },
                { id: 4, val: 'üçâ', payout: 50, weight: 20 },
                { id: 3, val: 'üçá', payout: 30, weight: 25 },
                { id: 2, val: 'üçã', payout: 20, weight: 30 },
                { id: 1, val: 'üçí', payout: 10, weight: 50 }
            ];
            // –ú–Ω–æ–∂–∏—Ç–µ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (ID 11)

            const SCATTER_PAYOUTS = { 3: 100, 4: 1000, 5: 10000 };

            const LINES_MAP = [
                { idx: 0, color: '#ef4444', path: [1, 1, 1, 1, 1] }, 
                { idx: 1, color: '#f97316', path: [0, 0, 0, 0, 0] }, 
                { idx: 2, color: '#eab308', path: [2, 2, 2, 2, 2] }, 
                { idx: 3, color: '#22c55e', path: [0, 1, 2, 1, 0] }, 
                { idx: 4, color: '#3b82f6', path: [2, 1, 0, 1, 2] }, 
                { idx: 5, color: '#a855f7', path: [0, 0, 1, 2, 2] }, 
                { idx: 6, color: '#ec4899', path: [2, 2, 1, 0, 0] }, 
                { idx: 7, color: '#06b6d4', path: [1, 0, 0, 0, 1] }, 
                { idx: 8, color: '#6366f1', path: [1, 2, 2, 2, 1] }  
            ]; 

            const BET_VALUES = [1, 5, 10, 20, 50, 100, 150, 200, 500, 1000, 1500, 2000, 5000, 10000, 20000, 50000, 100000];

            const AudioSys = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                
                playTone(freq, type, duration, vol = 0.1) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                },

                spin() {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const now = this.ctx.currentTime;
                    const duration = 0.3; 
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + duration);
                    gain.gain.setValueAtTime(0.35, now); 
                    gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now);
                    osc.stop(now + duration);
                },

                stop() { this.playTone(150, 'sine', 0.15, 0.5); },
                win() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.4, 0.15), i*80)); },
                scatter() { [800, 1200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.2, 0.1), i*150)); },
                bonusStart() { [392, 523, 659, 784].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3, 0.2), i*120)); },
                bombTick() { this.playTone(600, 'sawtooth', 0.1, 0.1); },
                bombExplode() { 
                    this.playTone(100, 'square', 0.5, 0.4); 
                    this.playTone(50, 'sawtooth', 0.8, 0.5); 
                },
                tick() { this.playTone(800, 'square', 0.03, 0.1); },
                selected() { this.playTone(1200, 'sine', 0.5, 0.3); },
                multAppear() { this.playTone(1500, 'square', 0.4, 0.2); }
            };

            class Reel {
                constructor(el, index) {
                    this.el = el;
                    this.index = index;
                    this.symbols = [];
                }
                get SYMBOL_HEIGHT() { return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--reel-height')) || 100; }

                init() {
                    this.el.innerHTML = '';
                    this.renderStrip(this.generateRandomSet(3)); 
                }

                generateRandomSet(count, boostedIds = [], boostVal = 30, isBonusMode = false) {
                    let arr = [];
                    let currentAssets = ASSETS.map(a => ({...a}));

                    currentAssets = currentAssets.map(asset => {
                        let newWeight = asset.weight;
                        if (asset.id === 9) {
                            newWeight = isBonusMode ? 15 : 0; 
                        }
                        if (boostedIds.includes(asset.id) && asset.id !== 8 && asset.id !== 9 && asset.id !== 10) newWeight += boostVal;
                        return { ...asset, weight: newWeight };
                    });

                    for(let i=0; i<count; i++) {
                        currentAssets.sort((a, b) => b.weight - a.weight);
                        const totalWeight = currentAssets.reduce((acc, cur) => acc + (cur.weight / 1.5), 0);
                        const rand = Math.random() * totalWeight;
                        let sum = 0;
                        let selected = null;
                        for(let s of currentAssets) {
                            sum += (s.weight / 1.5);
                            if(rand <= sum) { selected = s; break; }
                        }
                        if (!selected) selected = currentAssets[currentAssets.length - 1];
                        if (selected.id === 8) currentAssets = currentAssets.filter(a => a.id !== 8);
                        arr.push(ASSETS.find(a => a.id === selected.id));
                    }
                    return arr;
                }

                renderStrip(symbolDataArray) {
                    this.el.innerHTML = '';
                    symbolDataArray.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'slot-symbol';
                        
                        // –†–µ–Ω–¥–µ—Ä –º–Ω–æ–∂–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                        if (s.mul) {
                            div.innerText = s.val;
                            div.classList.add('mult-x' + s.mul);
                        } else {
                            div.innerText = s.val; 
                        }
                        this.el.appendChild(div);
                    });
                    this.symbols = symbolDataArray;
                }

                async spin(finalSymbols, duration, extraSymbols, isBonusMode) {
                    const currentVisible = this.symbols.slice(0, 3);
                    const filler = this.generateRandomSet(extraSymbols, [], 30, isBonusMode);
                    const fullStrip = [...finalSymbols, ...filler, ...currentVisible];
                    
                    this.renderStrip(fullStrip);
                    const startY = -((fullStrip.length - 3) * this.SYMBOL_HEIGHT);
                    
                    this.el.style.transition = 'none';
                    this.el.style.transform = `translateY(${startY}px)`;
                    this.el.offsetHeight; 

                    const easing = duration > 2000 ? 'cubic-bezier(0.1, 0, 0.3, 1)' : 'cubic-bezier(0.2, 0, 0.3, 1)';
                    this.el.style.transition = `transform ${duration}ms ${easing}`;
                    this.el.style.transform = `translateY(0px)`;

                    return new Promise(resolve => {
                        setTimeout(() => {
                            AudioSys.stop(); 
                            this.renderStrip(finalSymbols);
                            this.el.style.transition = 'none';
                            this.el.style.transform = 'translateY(0px)';
                            resolve();
                        }, duration);
                    });
                }
            }

            class SlotMachine {
                constructor() {
                    this.balance = parseInt(localStorage.getItem('jigu_bal_xl')) || 2000;
                    this.betPerLine = 20;
                    this.lines = 9;
                    this.isSpinning = false;
                    this.auto = false;
                    this.isWaitBonus = false; 
                    this.freeSpins = 0;
                    this.isBonusMode = false;
                    this.bonusTargetSymbol = null;

                    this.queuedBonus = false;

                    this.bonusSessionWin = 0; 

                    this.previewTimeout = null;
                    this.winCycleTimeout = null;
                    this.winCycleInterval = null;
                    
                    this.ui = {
                        bonusTotalDisplay: document.getElementById('bonus-total-display'),
                        bal: document.getElementById('ui-balance'),
                        win: document.getElementById('ui-win'),
                        bet: document.getElementById('ui-bet'),
                        total: document.getElementById('ui-total-bet'),
                        status: document.getElementById('status-text'),
                        btnSpin: document.getElementById('btn-spin'),
                        btnAuto: document.getElementById('btn-auto'),
                        spinText: document.getElementById('spin-text'),
                        svg: document.getElementById('paylines-svg'),
                        modal: document.getElementById('win-modal'),
                        modalAmt: document.getElementById('modal-win-amount'),
                        legend: document.getElementById('legend-grid'),
                        bonusModal: document.getElementById('bonus-modal'),
                        bonusModalInner: document.getElementById('bonus-modal-inner'),
                        bonusStrip: document.getElementById('bonus-strip'),
                        fsCounter: document.getElementById('fs-counter'),
                        activeBonusSymbol: document.getElementById('active-bonus-symbol'),
                        body: document.body,
                        gameWrapper: document.getElementById('game-wrapper')
                        
                    };

                    this.reels = [];
                    this.setupReels();
                    this.renderLegend();
                    this.updateUI();
                    this.updateLineButtons();
                }
                
                setupReels() {
                    const container = document.getElementById('slot-machine');
                    for(let i=0; i<5; i++) {
                        const col = document.createElement('div');
                        col.className = 'reel-col';
                        container.appendChild(col);
                        const reel = new Reel(col, i);
                        reel.init();
                        this.reels.push(reel);
                    }
                }

                renderLegend() {
                    this.ui.legend.innerHTML = '';
                    
                    const scatterInfo = document.createElement('div');
                    scatterInfo.className = 'col-span-4 md:col-span-9 bg-slate-800/80 rounded p-2 mb-2 text-center text-[10px] font-bold border border-white/10 grid grid-cols-1 md:grid-cols-3 gap-2 items-center';
                    scatterInfo.innerHTML = `
                        <div class="text-yellow-300">üíé SCATTER</div>
                        <div class="text-green-400">üåà WILD</div>
                        <div class="text-red-400">üí£ BOMB!</div>
                    `;
                    this.ui.legend.appendChild(scatterInfo);

                    ASSETS.forEach(item => {
                        if(item.id === 8 || item.id === 9) return; 
                        
                        const el = document.createElement('div');
                        el.className = 'bg-slate-800/50 rounded p-1 flex flex-col items-center justify-center border border-white/5';
                        if(item.id === 10) el.className += ' border-green-500/50 bg-green-900/20';
                        
                        el.innerHTML = `<div class="w-8 h-8 mb-1 flex items-center justify-center text-2xl">${item.val}</div><span class="text-[10px] font-bold text-yellow-400">x${item.payout}</span>`;
                        this.ui.legend.appendChild(el);
                    });
                }

                stopWinAnimation() {
                    if (this.winCycleTimeout) clearTimeout(this.winCycleTimeout);
                    if (this.winCycleInterval) clearInterval(this.winCycleInterval);
                    this.ui.svg.innerHTML = ''; 
                    document.querySelectorAll('.win-anim-scale').forEach(el => el.classList.remove('win-anim-scale'));
                    document.querySelectorAll('.win-anim-light').forEach(el => el.classList.remove('win-anim-light'));
                    document.querySelectorAll('.bomb-tick').forEach(el => el.classList.remove('bomb-tick'));
                }

                resetBalance() {
                    if(this.isBonusMode) return;
                    if(this.balance < 100) {
                        if(confirm("–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –¥–æ 2000?")) {
                            this.balance = 2000;
                            this.updateUI();
                            AudioSys.playTone(800, 'sine', 0.1);
                        }
                    }
                }

                adjustBet(direction) {
                    if(this.isSpinning || this.isBonusMode) return;
                    let currentIndex = BET_VALUES.indexOf(this.betPerLine);
                    if (currentIndex === -1) currentIndex = 0;
                    const nextIndex = currentIndex + (direction > 0 ? 1 : -1);
                    if (nextIndex >= 0 && nextIndex < BET_VALUES.length) {
                        this.betPerLine = BET_VALUES[nextIndex];
                        this.updateUI();
                        AudioSys.playTone(600, 'sine', 0.05);
                    }
                }

                closeWinModal() {
                    this.ui.modal.classList.add('hidden');
                    if (this.queuedBonus) {
                        this.queuedBonus = false;
                        setTimeout(() => {
                            this.showBonusEntryModal();
                            confetti({ particleCount: 100, spread: 100, origin: { y: 0.6 }, colors: ['#fbbf24', '#818cf8'], scalar: 1.2, ticks: 200 });
                        }, 500);
                    }
                }

                setLines(n) {
                    if(this.isSpinning || this.isBonusMode) return;
                    this.stopWinAnimation();
                    this.lines = n;
                    this.updateUI();
                    this.updateLineButtons();
                    this.drawLinesPreview();
                    AudioSys.playTone(600, 'sine', 0.05);
                }

                updateLineButtons() {
                    const btns = document.querySelectorAll('#lines-control-panel button');
                    btns.forEach(btn => {
                        const val = parseInt(btn.innerText);
                        if (val === this.lines) btn.classList.add('active');
                        else btn.classList.remove('active');
                        btn.disabled = this.isSpinning || this.isBonusMode;
                    });
                }

                toggleAuto() {
                    if(this.isBonusMode) return;
                    this.auto = !this.auto;
                    this.ui.btnAuto.classList.toggle('active-auto', this.auto);
                    if(this.auto && !this.isSpinning) this.spin();
                }

                getTotalBet() { return this.betPerLine * this.lines; }

                updateUI() {
                    this.ui.bal.innerText = this.balance;
                    this.ui.bet.innerText = this.betPerLine;
                    this.ui.total.innerText = this.getTotalBet();
                    localStorage.setItem('jigu_bal_xl', this.balance);
                    
                    const isLocked = this.isSpinning || this.isBonusMode || this.auto || this.isWaitBonus;
                    document.querySelectorAll('.bet-ctrl').forEach(b => b.disabled = isLocked);
                    document.querySelectorAll('.line-btn').forEach(b => b.disabled = isLocked);
                    this.ui.btnAuto.disabled = this.isBonusMode || this.isWaitBonus;

                    if (this.isBonusMode) {
                        this.ui.body.classList.add('bonus-active');
                        this.ui.bonusStrip.classList.remove('hidden');
                        this.ui.fsCounter.innerText = this.freeSpins;
                        this.ui.activeBonusSymbol.innerText = this.bonusTargetSymbol ? this.bonusTargetSymbol.val : '';
                        this.ui.status.innerHTML = "<span class='text-yellow-400 animate-pulse'>–ë–û–ù–£–° –ò–ì–†–ê!</span>";
                        this.ui.spinText.innerText = `FREE ${this.freeSpins}`;
                        this.ui.btnSpin.disabled = true; 
                    } else {
                        this.ui.body.classList.remove('bonus-active');
                        this.ui.bonusStrip.classList.add('hidden');
                        this.ui.spinText.innerText = "SPIN";
                        this.ui.btnSpin.disabled = this.isSpinning || this.isWaitBonus;
                        if(this.balance < this.getTotalBet()) {
                            this.ui.total.classList.add('text-red-500');
                            this.ui.status.innerHTML = "<span class='text-red-400'>–ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤</span>";
                        } else {
                            this.ui.total.classList.remove('text-red-500');
                            this.ui.status.innerText = this.isSpinning ? "–£–¥–∞—á–∏..." : "–í—Ä–∞—â–∞–π!";
                        }
                    }
                }

                triggerShake() {
                    const wrapper = document.getElementById('game-wrapper');
                    wrapper.classList.remove('shake-screen');
                    void wrapper.offsetWidth; 
                    wrapper.classList.add('shake-screen');
                    if (navigator.vibrate) navigator.vibrate(200); 
                    setTimeout(() => {
                        wrapper.classList.remove('shake-screen');
                    }, 300);
                }

                drawLinesPreview() {
                    this.stopWinAnimation();
                    if (this.previewTimeout) clearTimeout(this.previewTimeout);
                    for(let i=0; i<this.lines; i++) { this.drawLine(i); }
                    this.previewTimeout = setTimeout(() => {
                        if (!this.isSpinning) this.ui.svg.innerHTML = '';
                    }, 2000);
                }

                drawLine(lineIdx) {
                    if(!LINES_MAP[lineIdx]) return;
                    const cfg = LINES_MAP[lineIdx];
                    const path = cfg.path;
                    const getCoord = (c, r) => `${(c * 20) + 10} ${(r * 33.33) + 16.66}`;
                    let d = `M ${getCoord(0, path[0])}`;
                    for(let i=1; i<5; i++) { d += ` L ${getCoord(i, path[i])}`; }
                    const el = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    el.setAttribute("d", d);
                    el.setAttribute("stroke", cfg.color);
                    el.setAttribute("class", "payline-path");
                    this.ui.svg.appendChild(el);
                }

                getResults() {
                    let grid = [];
                    const boostVal = this.isBonusMode ? 40 : 20; 
                    grid[0] = this.reels[0].generateRandomSet(3, [], boostVal, this.isBonusMode);
                    for(let i=1; i<5; i++) {
                        const prevIds = grid[i-1].map(s => s.id);
                        grid[i] = this.reels[i].generateRandomSet(3, prevIds, boostVal, this.isBonusMode);
                    }
                    return grid;
                }

                showBonusEntryModal() {
                    this.ui.bonusModalInner.innerHTML = `
                        <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
                        <div class="relative z-10 flex flex-col items-center justify-center h-full w-full py-4">
                            <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600 drop-shadow-sm mb-2 uppercase">
                                –ë–û–ù–£–° –ò–ì–†–ê!
                            </h2>
                            <div class="text-white text-sm font-bold mb-4 opacity-90">
                                –í–´ –í–´–ò–ì–†–ê–õ–ò <span class="text-yellow-400 text-lg">15</span> FREE SPINS
                            </div>
                            <div class="w-32 h-32 bg-slate-900 rounded-2xl border-4 border-yellow-500 flex items-center justify-center text-6xl shadow-[0_0_50px_rgba(234,179,8,0.3)] mb-6 relative shrink-0">
                                <div id="selection-symbol" class="text-white">‚ùì</div>
                            </div>
                            <div class="h-8 mb-4 w-full flex justify-center items-center">
                                <p id="selection-text" class="text-slate-300 text-xs font-bold tracking-widest uppercase">
                                    –û–ü–†–ï–î–ï–õ–ò–ú –ë–û–ù–£–°–ù–´–ô –°–ò–ú–í–û–õ
                                </p>
                            </div>
                            <button id="bonus-action-btn" class="w-full max-w-xs py-4 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-xl text-xl font-black text-white shadow-xl hover:scale-105 active:scale-95 transition-all border-t border-white/20">
                                –ö–†–£–¢–ò–¢–¨
                            </button>
                        </div>
                    `;
                    document.getElementById('bonus-action-btn').onclick = () => this.runSymbolSelectionAnimation();
                    this.ui.bonusModal.classList.remove('hidden');
                    AudioSys.bonusStart();
                }

                runSymbolSelectionAnimation() {
                    const validSymbols = ASSETS.filter(a => a.id >= 1 && a.id <= 7);
                    const symbolEl = document.getElementById('selection-symbol');
                    const textEl = document.getElementById('selection-text');
                    const btn = document.getElementById('bonus-action-btn');

                    btn.classList.add('opacity-0', 'pointer-events-none'); 
                    textEl.innerText = "–í–´–ë–ò–†–ê–ï–ú –ë–û–ï–í–£–Æ –ë–û–ú–ë–£...";
                    textEl.classList.add('animate-pulse', 'text-yellow-400');

                    let delay = 50; 
                    let prevSymbolId = -1;

                    const getWeightedSymbol = () => {
                        const totalWeight = validSymbols.reduce((acc, symbol) => acc + symbol.weight, 0);
                        let randomNum = Math.random() * totalWeight;
                        for (let asset of validSymbols) {
                            if (randomNum < asset.weight) {
                                return asset;
                            }
                            randomNum -= asset.weight;
                        }
                        return validSymbols[0]; 
                    };

                    const spin = () => {
                        let rand;
                        let attempts = 0;
                        do {
                            rand = getWeightedSymbol();
                            attempts++;
                        } while (rand.id === prevSymbolId && attempts < 5);
                        prevSymbolId = rand.id;
                        symbolEl.innerText = rand.val;
                        AudioSys.tick();

                        if (delay < 500) {
                            delay = Math.floor(delay * 1.15);
                            setTimeout(spin, delay);
                        } else {
                            this.bonusTargetSymbol = rand;
                            symbolEl.classList.add('symbol-landed');
                            AudioSys.selected();
                            textEl.classList.remove('animate-pulse');
                            textEl.innerHTML = `–°–ò–ú–í–û–õ –í–´–ë–†–ê–ù: <span class="text-white text-lg">${rand.val}</span>`;
                            btn.innerText = "–ù–ê–ß–ê–¢–¨ –ò–ì–†–£";
                            btn.classList.remove('opacity-0', 'pointer-events-none', 'bg-gradient-to-r', 'from-yellow-500', 'to-orange-600');
                            btn.classList.add('bg-green-600', 'hover:bg-green-500', 'btn-pop-in');
                            btn.onclick = () => this.startActualBonusGame();
                        }
                    };
                    spin();
                }

                startActualBonusGame() {
                    this.isWaitBonus = false; 
                    this.ui.bonusModal.classList.add('hidden');
                    this.isBonusMode = true;
                    this.freeSpins = 15;
                    this.updateUI();
                    AudioSys.bonusStart();
                    setTimeout(() => this.spin(), 1000);
                    this.bonusSessionWin = 0; 
                    this.ui.bonusTotalDisplay.innerText = "0"; 
                }

                endBonusRound() {
                    this.isBonusMode = false;
                    this.bonusTargetSymbol = null;
                    this.ui.btnSpin.disabled = false; 
                    this.updateUI();
                    this.showFloatingText(`TOTAL WIN: ${this.bonusSessionWin}`, true);
                    AudioSys.win();
                }

                // --- –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–ó–†–´–í–ê ---
                async processBombs(grid) {
                    let bombs = [];
                    grid.forEach((col, c) => col.forEach((s, r) => {
                        if (s.id === 9) bombs.push({c, r});
                    }));

                    if (bombs.length === 0) return; 

                    for (const b of bombs) {
                        const defaultReplacement = this.bonusTargetSymbol || ASSETS.find(a => a.id === 1);

                        const bombEl = this.reels[b.c].el.children[b.r];
                        if (bombEl) {
                            bombEl.classList.add('bomb-tick');
                            AudioSys.bombTick();
                        }
                        
                        await new Promise(r => setTimeout(r, 600)); 

                        AudioSys.bombExplode();
                        this.triggerShake(); 
                        
                        for (let c = b.c - 1; c <= b.c + 1; c++) {
                            for (let r = b.r - 1; r <= b.r + 1; r++) {
                                if (c >= 0 && c < 5 && r >= 0 && r < 3) {
                                    // –õ–æ–≥–∏–∫–∞ –∫—Ä–µ—Å—Ç–∞ (–±–µ–∑ —É–≥–ª–æ–≤)
                                    if (c !== b.c && r !== b.r) continue;

                                    const targetId = grid[c][r].id;
                                    
                                    // --- –í–ê–ñ–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ---
                                    if (targetId === 8) continue; // –°–∫–∞—Ç—Ç–µ—Ä –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
                                    if (targetId === 9 && (c !== b.c || r !== b.r)) continue; // –ß—É–∂–∏–µ –±–æ–º–±—ã –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
                                    if (targetId === 11) continue; // !!! –ó–ê–©–ò–¢–ê –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ú–ù–û–ñ–ò–¢–ï–õ–ï–ô !!!
                                    // -----------------------

                                    let finalReplacement = defaultReplacement;

                                    // –ï—Å–ª–∏ —ç—Ç–æ –¶–ï–ù–¢–† –≤–∑—Ä—ã–≤–∞ (—Å–∞–º–∞ –±–æ–º–±–∞), —Ç–æ –º–æ–∂–µ—Ç –≤—ã–ø–∞—Å—Ç—å –º–Ω–æ–∂–∏—Ç–µ–ª—å
                                    if (c === b.c && r === b.r) {
                                        const rand = Math.random() * 100;
                                        
                                        // 0.1% —à–∞–Ω—Å –Ω–∞ x50
                                        if (rand < 0.1) {
                                            finalReplacement = { id: 11, val: 'x50', mul: 50, payout: 0, weight: 0 };
                                        } 
                                        // 1% —à–∞–Ω—Å –Ω–∞ x10 (0.1 -> 1.1)
                                        else if (rand < 1.1) {
                                            finalReplacement = { id: 11, val: 'x10', mul: 10, payout: 0, weight: 0 };
                                        }
                                        // 3% —à–∞–Ω—Å –Ω–∞ x5 (1.1 -> 4.1)
                                        else if (rand < 4.1) {
                                            finalReplacement = { id: 11, val: 'x5', mul: 5, payout: 0, weight: 0 };
                                        }
                                        // 6% —à–∞–Ω—Å –Ω–∞ x3 (4.1 -> 10.1)
                                        else if (rand < 10.1) {
                                            finalReplacement = { id: 11, val: 'x3', mul: 3, payout: 0, weight: 0 };
                                        }
                                        // 10% —à–∞–Ω—Å –Ω–∞ x2 (10.1 -> 20.1)
                                        else if (rand < 20.1) {
                                            finalReplacement = { id: 11, val: 'x2', mul: 2, payout: 0, weight: 0 };
                                        }
                                    }

                                    // –ó–∞–º–µ–Ω—è–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö
                                    grid[c][r] = finalReplacement;
                                    
                                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤ DOM
                                    const cell = this.reels[c].el.children[r];
                                    if(cell) {
                                        // –ï—Å–ª–∏ –≤—ã–ø–∞–ª –º–Ω–æ–∂–∏—Ç–µ–ª—å - —Å—Ç–∞–≤–∏–º —Å—Ç–∏–ª–∏
                                        if (finalReplacement.mul) {
                                            cell.innerText = finalReplacement.val;
                                            cell.className = `slot-symbol explosion-flash mult-x${finalReplacement.mul}`;
                                            AudioSys.multAppear(); // –ó–≤—É–∫ –ø–æ—è–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª—è
                                        } else {
                                            cell.innerText = finalReplacement.val;
                                            cell.className = 'slot-symbol explosion-flash';
                                        }
                                        
                                        setTimeout(() => cell.classList.remove('explosion-flash'), 400);
                                    }
                                }
                            }
                        }
                        await new Promise(r => setTimeout(r, 400));
                    }
                }

                async spin() {
                    if(this.isSpinning || this.isWaitBonus) return;
                    const cost = this.getTotalBet();
                    if(!this.isBonusMode && this.balance < cost) {
                        if(this.auto) this.toggleAuto();
                        return;
                    }

                    this.stopWinAnimation();
                    this.isSpinning = true; 

                    if (!this.isBonusMode) {
                        this.balance -= cost;
                        this.ui.win.innerText = "0";
                    } else {
                        this.freeSpins--;
                        if(this.freeSpins < 0) this.freeSpins = 0;
                    }

                    this.updateUI(); 
                    AudioSys.spin(); 

                    const resultGrid = this.getResults(); 

                    let crownsPerReel = resultGrid.map(col => col.some(s => s.id === 8) ? 1 : 0);
                    const promises = this.reels.map((reel, i) => {
                        const delay = i; 
                        let duration = 800 + (i * 200);
                        let extraSymbols = 6 + i;
                        let previousCrownIndices = [];
                        for(let k=0; k < i; k++) {
                            if(crownsPerReel[k] === 1) previousCrownIndices.push(k);
                        }
                        if(previousCrownIndices.length >= 2) {
                            const secondCrownIndex = previousCrownIndices[1];
                            const multiplier = i - secondCrownIndex - 1;
                            duration += 1600 + (multiplier * 1600); 
                            extraSymbols = 24 + (multiplier * 24) + (i *2); 
                        }
                        return new Promise(r => setTimeout(() => {
                            if(crownsPerReel[i] === 1) {
                                const currentScattersCount = crownsPerReel.slice(0, i + 1).reduce((a, b) => a + b, 0);
                                const remainingReels = 4 - i;
                                if (currentScattersCount + remainingReels >= 3) {
                                    setTimeout(() => AudioSys.scatter(), duration - 20);
                                }
                            }
                            reel.spin(resultGrid[i], duration, extraSymbols, this.isBonusMode).then(r);
                        }, delay));
                    });

                    await Promise.all(promises);

                    if (this.isBonusMode) {
                        await this.processBombs(resultGrid);
                    }

                    this.checkWin(resultGrid);
                    
                    this.isSpinning = false;
                    this.updateUI();

                    if (this.isBonusMode) {
                        if (this.freeSpins > 0) setTimeout(() => this.spin(), 1000);
                        else setTimeout(() => this.endBonusRound(), 1000);
                    } else {
                        if(this.auto && !this.isWaitBonus) setTimeout(() => this.spin(), 300);
                    }
                }

                cycleWinLines(winLinesData) {
                    let currentIndex = 0;
                    const showNext = () => {
                        this.ui.svg.innerHTML = ''; 
                        document.querySelectorAll('.win-anim-light').forEach(el => {
                             el.classList.remove('win-anim-light');
                        });
                        const currentData = winLinesData[currentIndex];
                        this.drawLine(currentData.lineIdx); 
                        currentData.symbols.forEach(pos => {
                            this.addSymbolEffect(pos.c, pos.r, 'light');
                        });
                        currentIndex = (currentIndex + 1) % winLinesData.length;
                    };
                    showNext();
                    this.winCycleInterval = setInterval(showNext, 1000);
                }

                animateCount(element, start, end, duration) {
                    let startTimestamp = null;
                    const step = (timestamp) => {
                        if (!startTimestamp) startTimestamp = timestamp;
                        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                        const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                        const currentVal = Math.floor(progress * (end - start) + start);
                        element.innerText = currentVal;
                        if (progress < 1) {
                            window.requestAnimationFrame(step);
                        } else {
                            element.innerText = end;
                        }
                    };
                    window.requestAnimationFrame(step);
                }

                // --- –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–´–ü–õ–ê–¢ (–ú–ù–û–ñ–ò–¢–ï–õ–ò) ---
                // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê (–ú–Ω–æ–∂–∏—Ç–µ–ª—å = –ë–æ–Ω—É—Å–Ω—ã–π –°–∏–º–≤–æ–ª) ---
                checkWin(grid) {
    let totalWin = 0;
    let winLinesData = [];

    for(let i=0; i<this.lines; i++) {
        const lineCfg = LINES_MAP[i];
        if(!lineCfg) continue;
        const p = lineCfg.path;
        const lineSymbols = [grid[0][p[0]], grid[1][p[1]], grid[2][p[2]], grid[3][p[3]], grid[4][p[4]]];
        
        // –°–∫–∞—Ç—Ç–µ—Ä(8) –∏ –ë–æ–º–±–∞(9) –ª–æ–º–∞—é—Ç –ª–∏–Ω–∏—é —Å—Ä–∞–∑—É
        if (lineSymbols[0].id === 8 || lineSymbols[0].id === 9) continue;

        let targetId = null;
        let len = 0;
        let wCount = 0;      
        let rCount = 0;      
        let initialWilds = 0;
        
        let lineMultiplier = 1;

        for (let s of lineSymbols) {
            if (s.id === 8 || s.id === 9) break;

            if (s.mul && s.mul > 1) {
                lineMultiplier *= s.mul;
            }

            let effectiveId = s.id;
            if (s.id === 11) {
                effectiveId = this.bonusTargetSymbol ? this.bonusTargetSymbol.id : -999;
            }

            const isWild = (effectiveId === 10);
            if (isWild && targetId === null) initialWilds++;
            if (!isWild && targetId === null) targetId = effectiveId;

            if (isWild || effectiveId === targetId || targetId === null) {
                len++;
                if (isWild) wCount++; else rCount++;
            } else {
                break; 
            }
        }

        // --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨ ---
        let finalCount = 0;
        let finalAssetId = null;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ü–µ–ª–µ–≤–æ–π —Å–∏–º–≤–æ–ª –ö–æ—Ä–æ–Ω–æ–π (ID 7)
        const isCrown = (targetId === 7);
        // –ï—Å–ª–∏ –ö–æ—Ä–æ–Ω–∞ - –º–∏–Ω–∏–º—É–º 2, –∏–Ω–∞—á–µ 3
        const minLen = isCrown ? 2 : 3;

        if (targetId === null) {
            // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∏ –í–∞–π–ª–¥—ã (–†–∞–¥—É–≥–∏) - –≤—Å–µ–≥–¥–∞ –æ—Ç 3
            if (len >= 3) {
                finalCount = len;
                finalAssetId = 10;
            }
        } else {
            // –°–º–µ—à–∞–Ω–Ω–∞—è –ª–∏–Ω–∏—è
            // –î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ª–æ–≤–∏–µ: (isCrown && len >= 2), —á—Ç–æ–±—ã –∑–∞—Å—á–∏—Ç—ã–≤–∞—Ç—å [–ö–æ—Ä–æ–Ω–∞ + –í–∞–π–ª–¥] –∏–ª–∏ [–ö–æ—Ä–æ–Ω–∞ + –ö–æ—Ä–æ–Ω–∞]
            if (len >= minLen && (rCount > wCount || (isCrown && len === 2))) {
                finalCount = len;
                finalAssetId = targetId;
            } 
            else if (initialWilds >= 3) {
                finalCount = initialWilds;
                finalAssetId = 10;
            }
        }

        if (finalCount > 0) {
            const asset = ASSETS.find(a => a.id === finalAssetId);
            
            // --- –ù–ê–°–¢–†–û–ô–ö–ê –ú–ù–û–ñ–ò–¢–ï–õ–Ø –í–´–ü–õ–ê–¢–´ ---
            let mult = 1.0;
            if (finalCount === 2) mult = 0.05; // 5% –æ—Ç –ø–æ–ª–Ω–æ–π –≤—ã–ø–ª–∞—Ç—ã –∑–∞ 2 —Å–∏–º–≤–æ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25 –º–æ–Ω–µ—Ç)
            else if (finalCount === 3) mult = 0.2;
            else if (finalCount === 4) mult = 0.5;
            
            let winAmount = Math.floor(this.betPerLine * asset.payout * mult);
            winAmount *= lineMultiplier;

            totalWin += winAmount;
            
            let coords = [];
            for(let k=0; k<finalCount; k++) { 
                coords.push({ c: k, r: p[k] });
                this.addSymbolEffect(k, p[k], 'scale'); 
                this.addSymbolEffect(k, p[k], 'light');
            }
            winLinesData.push({ lineIdx: i, symbols: coords });
        }
    }

    // --- –î–ê–õ–ï–ï –ö–û–î –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (–õ–û–ì–ò–ö–ê –°–ö–ê–¢–¢–ï–†–û–í) ---
    let scatterCount = 0;
    let scatterPositions = []; 

    grid.forEach((col, colIdx) => {
        col.forEach((s, rowIdx) => {
            if(s.id === 8) {
                scatterCount++;
                scatterPositions.push({c: colIdx, r: rowIdx});
            }
        });
    });

    if(scatterCount >= 3) {
        scatterPositions.forEach(pos => {
            this.addSymbolEffect(pos.c, pos.r, 'scale');
            this.addSymbolEffect(pos.c, pos.r, 'light');
        });
        totalWin += (SCATTER_PAYOUTS[scatterCount] || 0);
        
        if (this.isBonusMode) {
            this.freeSpins += 15;
            this.showFloatingText("+15 FREE SPINS!", true); 
            AudioSys.bonusStart();
            confetti({ particleCount: 40, spread: 60, origin: { y: 0.6 }, colors: ['#fbbf24'], scalar: 1.3 });
        } else {
            this.isWaitBonus = true; 
            this.auto = false; 
            this.ui.btnAuto.classList.remove('active-auto');
            
            const isBigWin = totalWin >= this.getTotalBet() * 20;
            if (isBigWin) {
                this.queuedBonus = true;
            } else {
                setTimeout(() => {
                    this.showBonusEntryModal();
                    confetti({ particleCount: 100, spread: 100, origin: { y: 0.6 }, colors: ['#fbbf24', '#818cf8'], scalar: 1.2, ticks: 200 });
                }, 1000);
            }
        }
    } 

    if(totalWin > 0) {
        const oldBalance = this.balance;
        this.balance += totalWin;
        this.animateCount(this.ui.bal, oldBalance, this.balance, 1500);

        if (this.isBonusMode) {
            this.bonusSessionWin += totalWin;
            this.animateCount(this.ui.bonusTotalDisplay, this.bonusSessionWin - totalWin, this.bonusSessionWin, 1000);
        }

        this.ui.win.innerText = totalWin; 
        
        if(!this.isBonusMode) this.ui.status.innerHTML = `<span class="text-yellow-400 font-bold animate-pulse">–í–´–ò–ì–†–´–®: ${totalWin}!</span>`;
        AudioSys.win();
        
        if (winLinesData.length > 0) {
            this.ui.svg.innerHTML = '';
            winLinesData.forEach(w => this.drawLine(w.lineIdx));
            if (winLinesData.length > 1) {
                this.winCycleTimeout = setTimeout(() => this.cycleWinLines(winLinesData), 1000);
            }
        }
        this.showFloatingText(`+${totalWin}`);
        if(totalWin >= this.getTotalBet() * 20) this.celebrateBigWin(totalWin);
    }
}

                addSymbolEffect(c, r, type) {
                    const col = this.reels[c].el;
                    const symbol = col.children[r];
                    if(symbol) {
                        if(type === 'scale') symbol.classList.add('win-anim-scale');
                        if(type === 'light') symbol.classList.add('win-anim-light');
                    }
                }

                showFloatingText(txt, isSpecial = false) {
                    const el = document.createElement('div');
                    el.className = 'float-text';
                    const duration = isSpecial ? 3000 : 1500;
                    if (isSpecial) el.classList.add('float-bonus');
                    el.innerText = txt;
                    const existingCount = document.querySelectorAll('.float-text').length;
                    if (existingCount > 0) el.style.top = `calc(50% - ${existingCount * 60}px)`;
                    document.getElementById('game-wrapper').appendChild(el);
                    setTimeout(() => el.remove(), duration);
                }

                celebrateBigWin(amount) {
                    confetti({ 
                        particleCount: 80, 
                        spread: 100, 
                        origin: { y: 0.6 }, 
                        colors: ['#fbbf24', '#ef4444', '#3b82f6', '#d946ef'],
                        scalar: 1.2, 
                        ticks: 150   
                    });
                    if(!this.isBonusMode) { 
                        this.ui.modalAmt.innerText = amount;
                        this.ui.modal.classList.remove('hidden');
                    }
                }
            }

            function updateLayout() {
                const container = document.getElementById('slot-machine');
                if (!container) return;
                const colWidth = container.clientWidth / 5;
                document.documentElement.style.setProperty('--reel-height', `${colWidth}px`);
                document.documentElement.style.setProperty('--symbol-sz', `${colWidth * 0.6}px`);
            }

            window.addEventListener('resize', updateLayout);
            setTimeout(updateLayout, 0);   

            window.game = new SlotMachine();

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑—É–º–∞ –∂–µ—Å—Ç–∞–º–∏ (—â–∏–ø–æ–∫) –Ω–∞ iOS
    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑—É–º–∞ –¥–≤–æ–π–Ω—ã–º —Ç–∞–ø–æ–º (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
</script>
</body> <!-- –≠—Ç–æ —Å–∞–º—ã–π –∫–æ–Ω–µ—Ü –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞ -->
</html>



