<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JIGULUCK: Bonus Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');

        :root { --reel-height: 100px; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            user-select: none;
            overflow-y: auto;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease;
        }

        /* –°—Ç–∏–ª—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞ */
        .bonus-active .glass-panel#game-wrapper {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }
        .bonus-active body {
            background-image: none; /* –ú–æ–∂–Ω–æ –∑–∞—Ç–µ–º–Ω–∏—Ç—å —Ñ–æ–Ω */
        }

        .slot-window {
            overflow: hidden;
            position: relative;
            z-index: 10;
            mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        }

        .reel-col {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            will-change: transform; 
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .reel-col:last-child { border-right: none; }

        .slot-symbol {
            height: var(--reel-height);
            width: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
        }

        .slot-symbol img {
            width: 70%; height: 70%;
            object-fit: contain;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        #paylines-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .payline-path {
            fill: none; 
            stroke-width: 5;
            stroke-linecap: round; 
            stroke-linejoin: round;
            vector-effect: non-scaling-stroke;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8)); 
            stroke-dasharray: 2000; 
            stroke-dashoffset: 2000;
            animation: drawLine 0.5s forwards ease-in-out;
            opacity: 1;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .line-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #60a5fa;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        .win-pulse { 
            animation: winPulse 0.5s infinite alternate ease-in-out; 
            z-index: 10; 
        }
        @keyframes winPulse {
            0% { transform: scale(1); filter: brightness(1); }
            100% { transform: scale(1.2); filter: brightness(1.5) drop-shadow(0 0 15px rgba(255, 215, 0, 0.6)); }
        }

        .spin-btn {
            background: linear-gradient(180deg, #d946ef 0%, #7e22ce 100%);
            box-shadow: 0 6px 0 #581c87, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .spin-btn:active:not(:disabled) {
            transform: translateY(6px); box-shadow: 0 0 0 #581c87;
        }
        .spin-btn:disabled {
            filter: grayscale(1); cursor: not-allowed;
            transform: translateY(6px); box-shadow: 0 0 0 #581c87;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏ –±–æ–Ω—É—Å–µ (–∑–æ–ª–æ—Ç–∞—è) */
        .bonus-active .spin-btn {
            background: linear-gradient(180deg, #fcd34d 0%, #d97706 100%);
            box-shadow: 0 6px 0 #92400e;
            color: #78350f;
        }

        .auto-btn {
            background: linear-gradient(180deg, #475569 0%, #1e293b 100%);
            box-shadow: 0 6px 0 #0f172a, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .auto-btn.active-auto {
            background: linear-gradient(180deg, #22c55e 0%, #15803d 100%);
            box-shadow: 0 6px 0 #14532d;
        }
        .auto-btn:active {
            transform: translateY(6px); box-shadow: 0 0 0 #0f172a;
        }
        .auto-btn:disabled {
            opacity: 0.5; cursor: not-allowed; transform: translateY(6px); box-shadow: none;
        }

        .modal-backdrop { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .float-text {
            position: absolute;
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: #fbbf24; 
            font-weight: 900; 
            font-size: 4.5rem; 
            text-shadow: 0 4px 0 #000, 0 0 30px rgba(251, 191, 36, 0.5);
            pointer-events: none;
            z-index: 100; 
            animation: floatPop 1.5s ease-out forwards;
            white-space: nowrap;
        }

        @keyframes floatPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            15% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –±–æ–Ω—É—Å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .bonus-modal-content {
            background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%);
            border: 4px solid #fbbf24;
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.5);
        }
    </style>
</head>
<body class="w-full min-h-screen bg-[url('https://images.unsplash.com/photo-1596838132731-3301c3fd4317?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center bg-fixed flex flex-col items-center py-4">
    
    <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 via-slate-900/80 to-slate-900/95 backdrop-blur-[2px] pointer-events-none fixed"></div>

    <div class="relative z-10 w-full max-w-2xl flex flex-col items-center gap-3 px-2">
        
        <!-- Header -->
        <div class="w-full flex justify-between items-end">
            <div class="glass-panel px-4 py-2 rounded-2xl cursor-pointer hover:bg-white/5 transition group relative" onclick="game.resetBalance()">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–ë–∞–ª–∞–Ω—Å</div>
                <div class="text-2xl font-mono font-bold text-green-400" id="ui-balance">2000</div>
            </div>

            <div class="text-center pb-1">
                <h1 class="text-3xl md:text-4xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 drop-shadow-lg tracking-tighter">
                    JIGU<span class="text-white">XL</span>
                </h1>
            </div>

            <div class="glass-panel px-4 py-2 rounded-2xl text-right">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–í—ã–∏–≥—Ä—ã—à</div>
                <div class="text-2xl font-mono font-bold text-yellow-400" id="ui-win">0</div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="glass-panel p-3 md:p-5 rounded-[2rem] w-full shadow-2xl relative transition-colors duration-500" id="game-wrapper">
            
            <!-- Info Strip (Bonus Counter) -->
            <div id="bonus-strip" class="hidden absolute -top-4 left-0 w-full flex justify-center z-30">
                 <div class="bg-yellow-500 text-black font-black px-6 py-1 rounded-full shadow-[0_0_20px_rgba(234,179,8,0.6)] animate-pulse border-2 border-white">
                    FREE SPINS: <span id="fs-counter">15</span>
                 </div>
            </div>

            <!-- Slot Window -->
            <div class="bg-slate-950 rounded-xl border-4 border-slate-800 shadow-inner relative overflow-hidden mb-4" style="height: 300px;">
                <div class="absolute top-0 left-0 w-full h-6 bg-gradient-to-b from-black/70 to-transparent z-20 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-6 bg-gradient-to-t from-black/70 to-transparent z-20 pointer-events-none"></div>
                
                <div class="grid grid-cols-5 h-full w-full relative slot-window" id="slot-machine"></div>
                <svg id="paylines-svg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            </div>

            <!-- Controls -->
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex items-center justify-between">
                        <button class="bet-ctrl w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(-10)">-</button>
                        <div class="text-center">
                            <div class="text-[9px] text-slate-400 uppercase font-bold">–°—Ç–∞–≤–∫–∞</div>
                            <div class="font-mono font-bold text-white text-lg" id="ui-bet">20</div>
                        </div>
                        <button class="bet-ctrl w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition disabled:opacity-50" onclick="game.adjustBet(10)">+</button>
                    </div>

                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex flex-col justify-center items-center">
                        <div class="text-[9px] text-slate-400 uppercase font-bold mb-1">–õ–∏–Ω–∏–∏ (–ú–∞–∫—Å 9)</div>
                        <div class="flex gap-1 w-full justify-between px-1" id="lines-control-panel">
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(1)">1</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(3)">3</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(5)">5</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(7)">7</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent disabled:opacity-50" onclick="game.setLines(9)">9</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/40 rounded-lg p-2 flex justify-between items-center text-xs font-bold border border-white/5">
                    <span class="text-slate-400">–í–°–ï–ì–û: <span id="ui-total-bet" class="text-white text-sm ml-1">180</span></span>
                    <span id="status-text" class="text-right text-slate-300">–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ!</span>
                </div>

                <div class="flex gap-3 h-16 pb-1">
                    <button id="btn-auto" onclick="game.toggleAuto()" class="w-24 rounded-2xl auto-btn text-xs font-bold flex flex-col items-center justify-center text-slate-300 hover:text-white group">
                        <span class="text-xl mb-1 group-hover:scale-110 transition">üîÑ</span> AUTO
                    </button>
                    
                    <button id="btn-spin" onclick="game.spin()" class="flex-1 rounded-2xl spin-btn text-2xl font-black tracking-[0.2em] text-white text-shadow-sm border-b border-white/20 relative overflow-hidden group">
                        <span class="relative z-10" id="spin-text">SPIN</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="w-full glass-panel p-4 rounded-2xl">
            <h3 class="text-center text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">–¢–∞–±–ª–∏—Ü–∞ (–∑–∞ 5 —Å–∏–º–≤–æ–ª–æ–≤)</h3>
            <div class="grid grid-cols-4 md:grid-cols-8 gap-2" id="legend-grid"></div>
            <p class="text-[10px] text-center text-slate-500 mt-2">3 —Å–∏–º–≤–æ–ª–∞ = 20% | 4 —Å–∏–º–≤–æ–ª–∞ = 50% | 5 —Å–∏–º–≤–æ–ª–æ–≤ = 100%</p>
        </div>

    </div>

    <!-- Win Modal (Regular) -->
    <div id="win-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop bg-black/80 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="text-center transform transition-all scale-110">
            <h2 class="text-5xl font-black text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] mb-2 animate-bounce">MEGA WIN!</h2>
            <p class="text-6xl font-mono font-bold text-white drop-shadow-lg" id="modal-win-amount">0</p>
            <p class="text-sm text-slate-400 mt-8 uppercase tracking-widest">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å</p>
        </div>
    </div>

    <!-- Bonus Trigger Modal -->
    <div id="bonus-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop bg-black/90 backdrop-blur-md">
        <div class="bonus-modal-content p-8 rounded-3xl text-center transform transition-all max-w-md w-full mx-4 relative overflow-hidden">
            <!-- Shine effect -->
            <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
            
            <div class="relative z-10">
                <div class="text-6xl mb-4 animate-bounce">üëë</div>
                <h2 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-600 drop-shadow-sm mb-4 uppercase">
                    –ë–û–ù–£–° –ò–ì–†–ê!
                </h2>
                <p class="text-white text-lg font-bold mb-8">
                    –í–´ –í–´–ò–ì–†–ê–õ–ò <br>
                    <span class="text-5xl text-yellow-400 font-black">15</span> <br>
                    –ë–ï–°–ü–õ–ê–¢–ù–´–• –í–†–ê–©–ï–ù–ò–ô
                </p>
                <button onclick="game.startBonusRound()" class="w-full py-4 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-xl text-xl font-black text-white shadow-xl hover:scale-105 active:scale-95 transition-all border-t border-white/20">
                    –ó–ê–ü–£–°–¢–ò–¢–¨ –ë–û–ù–£–°
                </button>
            </div>
        </div>
    </div>

    <script>
            const ASSETS = [
                { id: 8, val: 'üëë', img: 'stickers/8.webp', payout: 0, weight: 5 }, 
                { id: 7, val: '7Ô∏è‚É£', img: 'stickers/7.webp', payout: 500, weight: 5 },
                { id: 6, val: 'üíé', img: 'stickers/6.webp', payout: 200, weight: 10 },
                { id: 5, val: 'üîî', img: 'stickers/5.webp', payout: 100, weight: 15 },
                { id: 4, val: 'üçâ', img: 'stickers/4.webp', payout: 50, weight: 20 },
                { id: 3, val: 'üçá', img: 'stickers/3.webp', payout: 30, weight: 25 },
                { id: 2, val: 'üçã', img: 'stickers/2.webp', payout: 20, weight: 30 },
                { id: 1, val: 'üçí', img: 'stickers/1.webp', payout: 10, weight: 50 }
            ];

            const SCATTER_PAYOUTS = { 3: 500, 4: 2000, 5: 10000 };

            const LINES_MAP = [
                { idx: 0, color: '#ef4444', path: [1, 1, 1, 1, 1] }, 
                { idx: 1, color: '#f97316', path: [0, 0, 0, 0, 0] }, 
                { idx: 2, color: '#eab308', path: [2, 2, 2, 2, 2] }, 
                { idx: 3, color: '#22c55e', path: [0, 1, 2, 1, 0] }, 
                { idx: 4, color: '#3b82f6', path: [2, 1, 0, 1, 2] }, 
                { idx: 5, color: '#a855f7', path: [0, 0, 1, 2, 2] }, 
                { idx: 6, color: '#ec4899', path: [2, 2, 1, 0, 0] }, 
                { idx: 7, color: '#06b6d4', path: [1, 0, 0, 0, 1] }, 
                { idx: 8, color: '#6366f1', path: [1, 2, 2, 2, 1] }  
            ];

            const AudioSys = {
                ctx: new (window.AudioContext || window.webkitAudioContext)(),
                playTone(freq, type, duration, vol = 0.1) {
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start();
                    osc.stop(this.ctx.currentTime + duration);
                },
                spin() { this.playTone(150, 'sawtooth', 0.1, 0.05); },
                stop() { this.playTone(100, 'square', 0.1, 0.1); },
                win() { [440, 554, 659, 880, 1100].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.5, 0.2), i*100)); },
                scatter() { [800, 1200].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.2, 0.3), i*150)); },
                bonusStart() { 
                    // –§–∞–Ω—Ñ–∞—Ä—ã
                    [392, 523, 659, 784, 523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.3, 0.2), i*120));
                }
            };

            class Reel {
                constructor(el, index) {
                    this.el = el;
                    this.index = index;
                    this.symbols = [];
                    this.SYMBOL_HEIGHT = 100; 
                }

                init() {
                    this.el.innerHTML = '';
                    this.renderStrip(this.generateRandomSet(3)); 
                }

                // boostVal - –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Å (30 –æ–±—ã—á–Ω–æ, 60 –≤ –±–æ–Ω—É—Å–µ)
                generateRandomSet(count, boostedIds = [], boostVal = 30) {
                    let arr = [];
                    let currentAssets = ASSETS.map(a => ({...a}));

                    currentAssets = currentAssets.map(asset => {
                        let newWeight = asset.weight;
                        if (boostedIds.includes(asset.id) && asset.id !== 8) newWeight += boostVal;
                        return { ...asset, weight: newWeight };
                    });

                    for(let i=0; i<count; i++) {
                        currentAssets.sort((a, b) => b.weight - a.weight);
                        const totalWeight = currentAssets.reduce((acc, cur) => acc + (cur.weight / 1.5), 0);

                        const rand = Math.random() * totalWeight;
                        let sum = 0;
                        let selected = null;
                        for(let s of currentAssets) {
                            sum += (s.weight / 1.5);
                            if(rand <= sum) { selected = s; break; }
                        }
                        if (!selected) selected = currentAssets[currentAssets.length - 1];

                        if (selected.id === 8) {
                            currentAssets = currentAssets.filter(a => a.id !== 8);
                        }

                        arr.push(ASSETS.find(a => a.id === selected.id));
                    }
                    return arr;
                }

                renderStrip(symbolDataArray) {
                    this.el.innerHTML = '';
                    symbolDataArray.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'slot-symbol';
                        div.innerHTML = `
                            <img src="${s.img}" 
                                onerror="this.style.display='none'; this.parentNode.innerText='${s.val}'"
                            >`;
                        this.el.appendChild(div);
                    });
                    this.symbols = symbolDataArray;
                }

                async spin(finalSymbols, duration, extraSymbols) {
                    const currentVisible = this.symbols.slice(0, 3);
                    
                    // –í–ê–ñ–ù–û: –¢—É—Ç –¥–ª—è "–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—è" –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                    const filler = this.generateRandomSet(extraSymbols);
                    const fullStrip = [...finalSymbols, ...filler, ...currentVisible];
                    
                    this.renderStrip(fullStrip);
                    const startY = -((fullStrip.length - 3) * this.SYMBOL_HEIGHT);
                    
                    this.el.style.transition = 'none';
                    this.el.style.transform = `translateY(${startY}px)`;
                    this.el.offsetHeight; 

                    const easing = duration > 4000 ? 'cubic-bezier(0.1, 0, 0.3, 1)' : 'cubic-bezier(0.1, 0, 0.3, 1)';

                    this.el.style.transition = `transform ${duration}ms ${easing}`;
                    this.el.style.transform = `translateY(0px)`;

                    return new Promise(resolve => {
                        setTimeout(() => {
                            AudioSys.stop();
                            resolve();
                        }, duration);
                    });
                }
            }

            class SlotMachine {
                constructor() {
                    this.balance = parseInt(localStorage.getItem('jigu_bal_xl')) || 2000;
                    this.betPerLine = 20;
                    this.lines = 9;
                    this.isSpinning = false;
                    this.auto = false;
                    
                    // BONUS SYSTEM
                    this.freeSpins = 0;
                    this.isBonusMode = false;
                    
                    this.previewTimeout = null;
                    this.winCycleTimeout = null;
                    this.winCycleInterval = null;
                    
                    this.ui = {
                        bal: document.getElementById('ui-balance'),
                        win: document.getElementById('ui-win'),
                        bet: document.getElementById('ui-bet'),
                        total: document.getElementById('ui-total-bet'),
                        status: document.getElementById('status-text'),
                        btnSpin: document.getElementById('btn-spin'),
                        btnAuto: document.getElementById('btn-auto'),
                        spinText: document.getElementById('spin-text'),
                        svg: document.getElementById('paylines-svg'),
                        modal: document.getElementById('win-modal'),
                        modalAmt: document.getElementById('modal-win-amount'),
                        legend: document.getElementById('legend-grid'),
                        
                        // New Bonus UI
                        bonusModal: document.getElementById('bonus-modal'),
                        bonusStrip: document.getElementById('bonus-strip'),
                        fsCounter: document.getElementById('fs-counter'),
                        body: document.body,
                        gameWrapper: document.getElementById('game-wrapper')
                    };

                    this.reels = [];
                    this.setupReels();
                    this.renderLegend();
                    this.updateUI();
                    this.updateLineButtons();
                }

                setupReels() {
                    const container = document.getElementById('slot-machine');
                    for(let i=0; i<5; i++) {
                        const col = document.createElement('div');
                        col.className = 'reel-col';
                        container.appendChild(col);
                        const reel = new Reel(col, i);
                        reel.init();
                        this.reels.push(reel);
                    }
                }

                renderLegend() {
                    this.ui.legend.innerHTML = '';
                    const scatterInfo = document.createElement('div');
                    scatterInfo.className = 'col-span-4 md:col-span-8 bg-yellow-500/20 rounded p-1 mb-2 text-center text-[10px] font-bold text-yellow-300 border border-yellow-500/30';
                    scatterInfo.innerHTML = `üëë SCATTER: 3x = –ë–û–ù–£–° (15 SPINS)`;
                    this.ui.legend.appendChild(scatterInfo);

                    ASSETS.forEach(item => {
                        if(item.id === 8) return; 
                        const el = document.createElement('div');
                        el.className = 'bg-slate-800/50 rounded p-1 flex flex-col items-center justify-center border border-white/5';
                        el.innerHTML = `
                            <div class="w-6 h-6 mb-1 flex items-center justify-center">
                                <img src="${item.img}" onerror="this.style.display='none'; this.parentNode.innerText='${item.val}'" class="w-full h-full object-contain drop-shadow">
                            </div>
                            <span class="text-[10px] font-bold text-yellow-400">x${item.payout}</span>
                        `;
                        this.ui.legend.appendChild(el);
                    });
                }

                stopWinAnimation() {
                    if (this.winCycleTimeout) clearTimeout(this.winCycleTimeout);
                    if (this.winCycleInterval) clearInterval(this.winCycleInterval);
                    this.ui.svg.innerHTML = ''; 
                }

                resetBalance() {
                    if(this.isBonusMode) return; // –ù–µ–ª—å–∑—è –ø–æ–ø–æ–ª–Ω—è—Ç—å –≤–æ –≤—Ä–µ–º—è –±–æ–Ω—É—Å–∞
                    if(this.balance < 100) {
                        if(confirm("–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –¥–æ 2000?")) {
                            this.balance = 2000;
                            this.updateUI();
                            AudioSys.playTone(800, 'sine', 0.1);
                        }
                    }
                }

                adjustBet(delta) {
                    if(this.isSpinning || this.isBonusMode) return; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                    const newBet = this.betPerLine + delta;
                    if(newBet >= 10 && newBet <= 500) {
                        this.betPerLine = newBet;
                        this.updateUI();
                        AudioSys.playTone(600, 'sine', 0.05);
                    }
                }

                setLines(n) {
                    if(this.isSpinning || this.isBonusMode) return; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                    this.stopWinAnimation();
                    this.lines = n;
                    this.updateUI();
                    this.updateLineButtons();
                    this.drawLinesPreview();
                    AudioSys.playTone(600, 'sine', 0.05);
                }

                updateLineButtons() {
                    const btns = document.querySelectorAll('#lines-control-panel button');
                    btns.forEach(btn => {
                        const val = parseInt(btn.innerText);
                        if (val === this.lines) btn.classList.add('active');
                        else btn.classList.remove('active');
                        
                        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                        btn.disabled = this.isSpinning || this.isBonusMode;
                    });
                }

                toggleAuto() {
                    if(this.isBonusMode) return; // –í –±–æ–Ω—É—Å–µ –∞–≤—Ç–æ –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ (—Å–∫—Ä—ã—Ç–æ)
                    this.auto = !this.auto;
                    this.ui.btnAuto.classList.toggle('active-auto', this.auto);
                    if(this.auto && !this.isSpinning) this.spin();
                }

                getTotalBet() { return this.betPerLine * this.lines; }

                updateUI() {
                    this.ui.bal.innerText = this.balance;
                    this.ui.bet.innerText = this.betPerLine;
                    this.ui.total.innerText = this.getTotalBet();
                    localStorage.setItem('jigu_bal_xl', this.balance);
                    
                    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤ —Å—Ç–∞–≤–æ–∫
                    const betBtns = document.querySelectorAll('.bet-ctrl');
                    betBtns.forEach(b => b.disabled = this.isSpinning || this.isBonusMode);
                    this.ui.btnAuto.disabled = this.isBonusMode;

                    if (this.isBonusMode) {
                        this.ui.body.classList.add('bonus-active');
                        this.ui.bonusStrip.classList.remove('hidden');
                        this.ui.fsCounter.innerText = this.freeSpins;
                        this.ui.status.innerHTML = "<span class='text-yellow-400 animate-pulse'>–ë–û–ù–£–° –ò–ì–†–ê!</span>";
                        this.ui.spinText.innerText = `FREE ${this.freeSpins}`;
                        this.ui.btnSpin.disabled = true; // –ö–Ω–æ–ø–∫–∞ —Å–ø–∏–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏–¥–µ—Ç –∞–≤—Ç–æ
                    } else {
                        this.ui.body.classList.remove('bonus-active');
                        this.ui.bonusStrip.classList.add('hidden');
                        this.ui.spinText.innerText = "SPIN";
                        
                        if(this.balance < this.getTotalBet()) {
                            this.ui.total.classList.add('text-red-500');
                            this.ui.status.innerHTML = "<span class='text-red-400'>–ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤</span>";
                        } else {
                            this.ui.total.classList.remove('text-red-500');
                            this.ui.status.innerText = this.isSpinning ? "–£–¥–∞—á–∏..." : "–í—Ä–∞—â–∞–π!";
                        }
                    }
                }

                drawLinesPreview() {
                    this.stopWinAnimation();
                    if (this.previewTimeout) clearTimeout(this.previewTimeout);
                    for(let i=0; i<this.lines; i++) { this.drawLine(i); }
                    this.previewTimeout = setTimeout(() => {
                        if (!this.isSpinning) this.ui.svg.innerHTML = '';
                    }, 2000);
                }

                drawLine(lineIdx) {
                    if(!LINES_MAP[lineIdx]) return;
                    const cfg = LINES_MAP[lineIdx];
                    const path = cfg.path;
                    const getCoord = (c, r) => `${(c * 20) + 10} ${(r * 33.33) + 16.66}`;
                    let d = `M ${getCoord(0, path[0])}`;
                    for(let i=1; i<5; i++) { d += ` L ${getCoord(i, path[i])}`; }
                    const el = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    el.setAttribute("d", d);
                    el.setAttribute("stroke", cfg.color);
                    el.setAttribute("class", "payline-path");
                    this.ui.svg.appendChild(el);
                }

                // –ò–∑–º–µ–Ω–µ–Ω–æ: —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ–º boostVal –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
                getResults() {
                    let grid = [];
                    // –í –±–æ–Ω—É—Å–µ –±—É—Å—Ç 60, –≤ –æ–±—ã—á–Ω–æ–π 30
                    const boostVal = this.isBonusMode ? 60 : 30; 
                    
                    grid[0] = this.reels[0].generateRandomSet(3);
                    for(let i=1; i<5; i++) {
                        const prevIds = grid[i-1].map(s => s.id);
                        // –ü–µ—Ä–µ–¥–∞–µ–º boostVal
                        grid[i] = this.reels[i].generateRandomSet(3, prevIds, boostVal);
                    }
                    return grid;
                }

                startBonusRound() {
                    this.ui.bonusModal.classList.add('hidden');
                    this.isBonusMode = true;
                    this.freeSpins = 15;
                    this.auto = false; // –í—ã–∫–ª—é—á–∞–µ–º –æ–±—ã—á–Ω–æ–µ –∞–≤—Ç–æ
                    this.ui.btnAuto.classList.remove('active-auto');
                    
                    this.updateUI();
                    AudioSys.bonusStart();
                    
                    // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ —Å–ø–∏–Ω–∞
                    setTimeout(() => this.spin(), 1000);
                }

                endBonusRound() {
                    this.isBonusMode = false;
                    this.updateUI();
                    this.showFloatingText("BONUS COMPLETE");
                    AudioSys.win();
                }

                async spin() {
                    const cost = this.getTotalBet();
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–ø–∏–Ω–∞
                    // –ï—Å–ª–∏ –±–æ–Ω—É—Å - –±–∞–ª–∞–Ω—Å –Ω–µ –≤–∞–∂–µ–Ω. –ï—Å–ª–∏ –æ–±—ã—á–Ω–∞—è - –Ω—É–∂–µ–Ω –±–∞–ª–∞–Ω—Å.
                    if(this.isSpinning) return;
                    if(!this.isBonusMode && this.balance < cost) {
                        if(this.auto) this.toggleAuto();
                        return;
                    }

                    this.stopWinAnimation();
                    this.isSpinning = true;

                    // –°–ø–∏—Å–∞–Ω–∏–µ –¥–µ–Ω–µ–≥ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±–æ–Ω—É—Å)
                    if (!this.isBonusMode) {
                        this.balance -= cost;
                        this.ui.win.innerText = "0";
                    } else {
                        // –í –±–æ–Ω—É—Å–µ —É–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                        this.freeSpins--;
                        if(this.freeSpins < 0) this.freeSpins = 0;
                    }

                    this.ui.btnSpin.disabled = true;
                    document.querySelectorAll('.win-pulse').forEach(el => el.classList.remove('win-pulse'));
                    this.updateUI();
                    
                    const resultGrid = this.getResults(); 

                    let crownsPerReel = resultGrid.map(col => col.some(s => s.id === 8) ? 1 : 0);
                    
                    const promises = this.reels.map((reel, i) => {
                        const delay = i; 
                        let duration = 800 + (i * 200);
                        let extraSymbols = 6 + i;

                        // 1. –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –≤—Å–µ—Ö –±–∞—Ä–∞–±–∞–Ω–æ–≤ —Å –∫–æ—Ä–æ–Ω–∞–º–∏ –°–õ–ï–í–ê –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ (i)
                        let previousCrownIndices = [];
                        for(let k=0; k < i; k++) {
                            if(crownsPerReel[k] === 1) previousCrownIndices.push(k);
                        }

                        // 2. –ï—Å–ª–∏ —Å–ª–µ–≤–∞ —É–∂–µ –µ—Å—Ç—å 2 –∏–ª–∏ –±–æ–ª—å—à–µ –∫–æ—Ä–æ–Ω—ã
                        if(previousCrownIndices.length >= 2) {
                            // –ë–µ—Ä–µ–º –∏–Ω–¥–µ–∫—Å –±–∞—Ä–∞–±–∞–Ω–∞, –≥–¥–µ –≤—ã–ø–∞–ª–∞ –∏–º–µ–Ω–Ω–æ –í–¢–û–†–ê–Ø –∫–æ—Ä–æ–Ω–∞
                            const secondCrownIndex = previousCrownIndices[1];
                            
                            // –°—á–∏—Ç–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—Ç–æ—Ä–æ–π –∫–æ—Ä–æ–Ω—ã
                            // –ï—Å–ª–∏ –≤—Ç–æ—Ä–∞—è –∫–æ—Ä–æ–Ω–∞ –Ω–∞ 2-–º –±–∞—Ä–∞–±–∞–Ω–µ, —Ç–æ 3-–π (i=3) –ø–æ–ª—É—á–∏—Ç: 3 - 2 - 1 = 0
                            const multiplier = i - secondCrownIndex - 1;

                            // –ü—Ä–∏–º–µ–Ω—è–µ–º
                            duration += 2000 + (multiplier * 2000); 
                            extraSymbols = 15 + (multiplier * 15); 
                        }

                        return new Promise(r => setTimeout(() => {
                            AudioSys.spin();
                            if(crownsPerReel[i] === 1) {
                                // –ó–≤—É–∫ —Å–∫–∞—Ç—Ç–µ—Ä–∞ —á—É—Ç—å —Ä–∞–Ω—å—à–µ –∫–æ–Ω—Ü–∞ –≤—Ä–∞—â–µ–Ω–∏—è
                                setTimeout(() => AudioSys.scatter(), duration - 300);
                            }
                            reel.spin(resultGrid[i], duration, extraSymbols).then(r);
                        }, delay));
                    });

                    await Promise.all(promises);

                    this.checkWin(resultGrid);
                    
                    this.isSpinning = false;
                    this.ui.btnSpin.disabled = false;
                    this.updateUI();

                    // –õ–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ä–∞—â–µ–Ω–∏—è
                    if (this.isBonusMode) {
                        if (this.freeSpins > 0) {
                            // –ó–∞–¥–µ—Ä–∂–∫–∞ 2000–º—Å –¥–ª—è –±–æ–Ω—É—Å–∞
                            setTimeout(() => this.spin(), 1000);
                        } else {
                            setTimeout(() => this.endBonusRound(), 1000);
                        }
                    } else {
                        // –û–±—ã—á–Ω—ã–π –∞–≤—Ç–æ-—Å–ø–∏–Ω (300–º—Å)
                        if(this.auto) setTimeout(() => this.spin(), 300);
                    }
                }

                cycleWinLines(indices) {
                    if (indices.length === 0) return;
                    if (indices.length === 1) {
                        this.ui.svg.innerHTML = '';
                        this.drawLine(indices[0]);
                        return;
                    }
                    let currentIndex = 0;
                    const showNext = () => {
                        this.ui.svg.innerHTML = ''; 
                        this.drawLine(indices[currentIndex]); 
                        currentIndex = (currentIndex + 1) % indices.length;
                    };
                    showNext();
                    this.winCycleInterval = setInterval(showNext, 1000);
                }

                checkWin(grid) {
                    let totalWin = 0;
                    let winLinesIndices = [];

                    // 1. Lines
                    for(let i=0; i<this.lines; i++) {
                        const lineCfg = LINES_MAP[i];
                        if(!lineCfg) continue;
                        const p = lineCfg.path; 
                        
                        const lineSymbols = [
                            grid[0][p[0]], grid[1][p[1]], grid[2][p[2]], grid[3][p[3]], grid[4][p[4]]
                        ];

                        const firstSymbolId = lineSymbols[0].id;
                        if(firstSymbolId === 8) continue;

                        let matchCount = 1;
                        for(let k=1; k<5; k++) {
                            if(lineSymbols[k].id === firstSymbolId) matchCount++;
                            else break;
                        }

                        if(matchCount >= 3) {
                            const basePayout = this.betPerLine * lineSymbols[0].payout;
                            let multiplier = matchCount === 3 ? 0.2 : (matchCount === 4 ? 0.5 : 1.0);
                            const winAmount = Math.floor(basePayout * multiplier);
                            
                            totalWin += winAmount;
                            winLinesIndices.push(i);
                            for(let k=0; k<matchCount; k++) { this.highlightSymbol(k, p[k]); }
                        }
                    }

                    // 2. Scatters (Crowns)
                    let scatterCount = 0;
                    let scatterPositions = [];

                    grid.forEach((col, colIdx) => {
                        col.forEach((s, rowIdx) => {
                            if(s.id === 8) {
                                scatterCount++;
                                scatterPositions.push({c: colIdx, r: rowIdx});
                            }
                        });
                    });

                    if(scatterCount >= 3) {
                        const scatterWin = SCATTER_PAYOUTS[scatterCount] || 0;
                        totalWin += scatterWin;
                        scatterPositions.forEach(pos => this.highlightSymbol(pos.c, pos.r));
                        
                        // BONUS TRIGGER LOGIC
                        if (this.isBonusMode) {
                            // RETRIGGER (–ï—Å–ª–∏ —É–∂–µ –≤ –±–æ–Ω—É—Å–µ - –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏–Ω—ã)
                            this.freeSpins += 15;
                            this.showFloatingText("+15 FREE SPINS!");
                            AudioSys.bonusStart();
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24'] });
                        } else {
                            // START NEW BONUS (–ï—Å–ª–∏ –æ–±—ã—á–Ω–∞—è –∏–≥—Ä–∞)
                            
                            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
                            this.auto = false; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ
                            this.ui.btnAuto.classList.remove('active-auto'); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–Ω–æ–ø–∫–∏
                            // -------------------------

                            setTimeout(() => {
                                this.ui.bonusModal.classList.remove('hidden');
                                AudioSys.bonusStart();
                                confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 }, colors: ['#fbbf24', '#818cf8'] });
                            }, 500);
                        }
                    }

                    if(totalWin > 0) {
                        this.balance += totalWin;
                        this.ui.win.innerText = totalWin; 
                        
                        if(!this.isBonusMode) {
                             this.ui.status.innerHTML = `<span class="text-yellow-400 font-bold animate-pulse">–í–´–ò–ì–†–´–®: ${totalWin}!</span>`;
                        }
                        
                        AudioSys.win();
                        
                        if (winLinesIndices.length > 0) {
                            this.ui.svg.innerHTML = '';
                            winLinesIndices.forEach(idx => this.drawLine(idx));
                            if (winLinesIndices.length > 1) {
                                this.winCycleTimeout = setTimeout(() => {
                                    this.cycleWinLines(winLinesIndices);
                                }, 1000);
                            }
                        }

                        this.showFloatingText(`+${totalWin}`);
                        if(totalWin >= this.getTotalBet() * 20) this.celebrateBigWin(totalWin);
                    }
                }

                highlightSymbol(colIdx, rowIdx) {
                    const col = this.reels[colIdx].el;
                    const symbols = col.children;
                    if(symbols[rowIdx]) symbols[rowIdx].classList.add('win-pulse');
                }

                showFloatingText(txt) {
                    const el = document.createElement('div');
                    el.className = 'float-text';
                    el.innerText = txt;
                    document.getElementById('game-wrapper').appendChild(el);
                    setTimeout(() => el.remove(), 1500);
                }

                celebrateBigWin(amount) {
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#fbbf24', '#ef4444', '#3b82f6', '#d946ef'] });
                    if(!this.isBonusMode) { // –í –±–æ–Ω—É—Å–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫–æ–π big win, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
                        this.ui.modalAmt.innerText = amount;
                        this.ui.modal.classList.remove('hidden');
                    }
                }
            }

            window.game = new SlotMachine();
    </script>
</body>
</html>
