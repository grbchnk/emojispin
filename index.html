<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JIGULUCK: Ultimate Remastered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap');

        :root { --reel-height: 120px; }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            user-select: none;
            overflow-y: auto;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .slot-window {
            overflow: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        }

        .reel-col {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            will-change: transform; 
        }

        .slot-symbol {
            height: var(--reel-height);
            width: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
        }

        .slot-symbol img {
            width: 80%; height: 80%;
            object-fit: contain;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        .blur-move { transform: scale(1); }

        #paylines-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
        }

        .payline-path {
            fill: none; 
            stroke-width: 1.5; 
            stroke-linecap: round; stroke-linejoin: round;
            filter: drop-shadow(0 0 2px rgba(0,0,0,1)); 
            stroke-dasharray: 1000; stroke-dashoffset: 1000;
            animation: drawLine 0.5s forwards ease-out;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        .line-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #60a5fa;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }

        .win-pulse { animation: winPulse 0.8s infinite alternate; z-index: 10; }
        @keyframes winPulse {
            0% { transform: scale(1); filter: brightness(1); }
            100% { transform: scale(1.15); filter: brightness(1.5) drop-shadow(0 0 10px gold); }
        }

        .spin-btn {
            background: linear-gradient(180deg, #d946ef 0%, #7e22ce 100%);
            box-shadow: 0 6px 0 #581c87, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .spin-btn:active:not(:disabled) {
            transform: translateY(6px); box-shadow: 0 0 0 #581c87;
        }
        .spin-btn:disabled {
            filter: grayscale(1); cursor: not-allowed;
            transform: translateY(6px); box-shadow: 0 0 0 #581c87;
        }

        .auto-btn {
            background: linear-gradient(180deg, #475569 0%, #1e293b 100%);
            box-shadow: 0 6px 0 #0f172a, 0 15px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .auto-btn.active-auto {
            background: linear-gradient(180deg, #22c55e 0%, #15803d 100%);
            box-shadow: 0 6px 0 #14532d;
        }
        .auto-btn:active {
            transform: translateY(6px); box-shadow: 0 0 0 #0f172a;
        }

        .modal-backdrop { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .float-text {
            position: absolute;
            top: 200px; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: #fbbf24; 
            font-weight: 900; 
            font-size: 4.5rem; 
            text-shadow: 0 4px 0 #000, 0 0 30px rgba(251, 191, 36, 0.5);
            pointer-events: none;
            z-index: 100; 
            animation: floatPop 1.2s ease-out forwards;
            white-space: nowrap;
        }

        @keyframes floatPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
        }
    </style>
</head>
<body class="w-full min-h-screen bg-[url('https://images.unsplash.com/photo-1596838132731-3301c3fd4317?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center bg-fixed flex flex-col items-center py-6">
    
    <div class="absolute inset-0 bg-gradient-to-b from-slate-900/90 via-slate-900/80 to-slate-900/95 backdrop-blur-[2px] pointer-events-none fixed"></div>

    <div class="relative z-10 w-full max-w-md flex flex-col items-center gap-4 px-2">
        
        <div class="w-full flex justify-between items-end">
            <div class="glass-panel px-4 py-2 rounded-2xl cursor-pointer hover:bg-white/5 transition group relative" onclick="game.resetBalance()">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–ë–∞–ª–∞–Ω—Å</div>
                <div class="text-2xl font-mono font-bold text-green-400" id="ui-balance">1000</div>
                <div class="absolute top-full mt-2 left-0 bg-slate-800 text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap border border-slate-600">
                    –ù–∞–∂–º–∏ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                </div>
            </div>

            <div class="text-center pb-1">
                <h1 class="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 drop-shadow-lg tracking-tighter">
                    JIGULUCK
                </h1>
            </div>

            <div class="glass-panel px-4 py-2 rounded-2xl text-right">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">–í—ã–∏–≥—Ä—ã—à</div>
                <div class="text-2xl font-mono font-bold text-yellow-400" id="ui-win">0</div>
            </div>
        </div>

        <div class="glass-panel p-4 rounded-[2rem] w-full shadow-2xl relative" id="game-wrapper">
            
            <div class="bg-slate-950 rounded-xl border-4 border-slate-800 shadow-inner relative overflow-hidden mb-4" style="height: 360px;">
                <div class="absolute top-0 left-0 w-full h-8 bg-gradient-to-b from-black/60 to-transparent z-10 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-black/60 to-transparent z-10 pointer-events-none"></div>
                
                <div class="grid grid-cols-3 h-full w-full relative slot-window" id="slot-machine"></div>
                <svg id="paylines-svg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            </div>

            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex items-center justify-between">
                        <button class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition" onclick="game.adjustBet(-10)">-</button>
                        <div class="text-center">
                            <div class="text-[9px] text-slate-400 uppercase font-bold">–°—Ç–∞–≤–∫–∞</div>
                            <div class="font-mono font-bold text-white text-lg" id="ui-bet">20</div>
                        </div>
                        <button class="w-8 h-8 rounded-lg bg-slate-700 hover:bg-slate-600 font-bold text-lg active:scale-95 transition" onclick="game.adjustBet(10)">+</button>
                    </div>

                    <div class="bg-slate-800/50 rounded-xl p-2 border border-slate-700 flex flex-col justify-center items-center">
                        <div class="text-[9px] text-slate-400 uppercase font-bold mb-1">–õ–∏–Ω–∏–∏</div>
                        <div class="flex gap-1 w-full justify-between px-1" id="lines-control-panel">
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent" onclick="game.setLines(1)">1</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent" onclick="game.setLines(3)">3</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent" onclick="game.setLines(5)">5</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent" onclick="game.setLines(7)">7</button>
                            <button class="line-btn w-6 h-6 rounded bg-slate-700 text-[10px] font-bold hover:bg-slate-600 transition border border-transparent" onclick="game.setLines(9)">9</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/40 rounded-lg p-2 flex justify-between items-center text-xs font-bold border border-white/5">
                    <span class="text-slate-400">–í–°–ï–ì–û: <span id="ui-total-bet" class="text-white text-sm ml-1">100</span></span>
                    <span id="status-text" class="text-right text-slate-300">–£–¥–∞—á–∏!</span>
                </div>

                <div class="flex gap-3 h-16 pb-1">
                    <button id="btn-auto" onclick="game.toggleAuto()" class="w-24 rounded-2xl auto-btn text-xs font-bold flex flex-col items-center justify-center text-slate-300 hover:text-white group">
                        <span class="text-xl mb-1 group-hover:scale-110 transition">üîÑ</span> AUTO
                    </button>
                    
                    <button id="btn-spin" onclick="game.spin()" class="flex-1 rounded-2xl spin-btn text-2xl font-black tracking-[0.2em] text-white text-shadow-sm border-b border-white/20 relative overflow-hidden group">
                        <span class="relative z-10">SPIN</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-500"></div>
                    </button>
                </div>
            </div>
        </div>

        <div class="w-full glass-panel p-4 rounded-2xl">
            <h3 class="text-center text-xs font-bold text-slate-400 uppercase mb-3 tracking-widest">–¢–∞–±–ª–∏—Ü–∞ –≤—ã–ø–ª–∞—Ç</h3>
            <div class="grid grid-cols-4 gap-2" id="legend-grid"></div>
        </div>

    </div>

    <div id="win-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop bg-black/80 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="text-center transform transition-all scale-110">
            <h2 class="text-5xl font-black text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] mb-2 animate-bounce">BIG WIN!</h2>
            <p class="text-6xl font-mono font-bold text-white drop-shadow-lg" id="modal-win-amount">0</p>
            <p class="text-sm text-slate-400 mt-8 uppercase tracking-widest">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å</p>
        </div>
    </div>

    <script>
        const ASSETS = [
            { id: 8, val: 'üëë', img: 'stickers/8_.webp', payout: 500, weight: 3 },
            { id: 7, val: '7Ô∏è‚É£', img: 'stickers/7_.webp', payout: 100, weight: 5 },
            { id: 6, val: 'üíé', img: 'stickers/6_.webp', payout: 50, weight: 10 },
            { id: 5, val: 'üîî', img: 'stickers/5_.webp', payout: 25, weight: 15 },
            { id: 4, val: 'üçâ', img: 'stickers/4_.webp', payout: 20, weight: 20 },
            { id: 3, val: 'üçá', img: 'stickers/3_.webp', payout: 15, weight: 25 },
            { id: 2, val: 'üçã', img: 'stickers/2_.webp', payout: 10, weight: 30 },
            { id: 1, val: 'üçí', img: 'stickers/1_.webp', payout: 5, weight: 50 }
        ];

        const LINES_MAP = [
            { idx: 0, color: '#ef4444', path: [1, 1, 1] },
            { idx: 1, color: '#f97316', path: [0, 0, 0] },
            { idx: 2, color: '#eab308', path: [2, 2, 2] },
            { idx: 3, color: '#22c55e', path: [0, 1, 2] },
            { idx: 4, color: '#3b82f6', path: [2, 1, 0] },
            { idx: 5, color: '#a855f7', path: [0, 1, 0] },
            { idx: 6, color: '#ec4899', path: [2, 1, 2] },
            { idx: 7, color: '#06b6d4', path: [1, 0, 1] },
            { idx: 8, color: '#6366f1', path: [1, 2, 1] }
        ];

        const AudioSys = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone(freq, type, duration, vol = 0.1) {
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            spin() { this.playTone(150, 'sawtooth', 0.1, 0.05); },
            stop() { this.playTone(100, 'square', 0.1, 0.1); },
            win() { [440, 554, 659, 880].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.4, 0.2), i*100)); }
        };

        class Reel {
            constructor(el, index) {
                this.el = el;
                this.index = index;
                this.symbols = [];
                this.SYMBOL_HEIGHT = 120; 
            }

            init() {
                this.el.innerHTML = '';
                this.renderStrip(this.generateRandomSet(3)); 
            }

            generateRandomSet(count, boostedIds = []) {
                let arr = [];
                
                // 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –∞—Å—Å–µ—Ç–æ–≤ —Å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –≤–µ—Å–∞–º–∏
                const tempAssets = ASSETS.map(asset => {
                    let newWeight = asset.weight;
                    // –ï—Å–ª–∏ ID –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ "–±—É—Å—Ç–∞", –¥–æ–±–∞–≤–ª—è–µ–º +30 –∫ –≤–µ—Å—É (–æ—á–µ–Ω—å —Å–∏–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å)
                    if (boostedIds.includes(asset.id)) {
                        newWeight += 30; 
                    }
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å –Ω–æ–≤—ã–º –≤–µ—Å–æ–º
                    return { ...asset, weight: newWeight };
                });

                // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (–æ—Ç —Ä–µ–¥–∫–∏—Ö –∫ —á–∞—Å—Ç—ã–º –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç, –∑–¥–µ—Å—å –ø–æ –≤–µ—Å—É)
                tempAssets.sort((a, b) => b.weight - a.weight);

                // 3. –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É –≤–µ—Å–æ–≤ (–æ–Ω–∞ —Ç–µ–ø–µ—Ä—å –±–æ–ª—å—à–µ 100 –∏–∑-–∑–∞ –±—É—Å—Ç–∞)
                // –î–µ–ª–∏—Ç–µ–ª—å 1.5 –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–Ω–∞–º–∏–∫–∏, –Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º
                const totalWeight = tempAssets.reduce((acc, cur) => acc + (cur.weight / 1.5), 0);

                for(let i=0; i<count; i++) {
                    const rand = Math.random() * totalWeight;
                    let sum = 0;
                    let selected = null;

                    for(let s of tempAssets) {
                        sum += (s.weight / 1.5);
                        if(rand <= sum) { 
                            selected = s; 
                            break; 
                        }
                    }
                    
                    // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–æ—Å–∫–æ—á–∏–ª–∏ (–∏–∑-–∑–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è), –±–µ—Ä–µ–º —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π (–ø–æ—Å–ª–µ–¥–Ω–∏–π –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –±—ã–ª cherry)
                    // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ –ø–æ –≤–µ—Å—É (b - a), —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–≤—ã–π. 
                    // –ß—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –ª–æ–≥–∏–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –≤–µ—Ä–Ω–µ–º asset —Å —Ç–µ–º –∂–µ ID –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞.
                    if (!selected) selected = tempAssets[tempAssets.length - 1];
                    
                    // –í–∞–∂–Ω–æ: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –∏–∑ ASSETS, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –∫–ª–æ–Ω—ã
                    const originalAsset = ASSETS.find(a => a.id === selected.id);
                    arr.push(originalAsset);
                }
                return arr;
            }

            renderStrip(symbolDataArray) {
                this.el.innerHTML = '';
                symbolDataArray.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'slot-symbol';
                    div.innerHTML = `<img src="${s.img}" onerror="this.style.display='none'; this.parentNode.innerText='${s.val}'" alt="${s.val}">`;
                    this.el.appendChild(div);
                });
                this.symbols = symbolDataArray;
            }

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä extraSymbols (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3)
            async spin(finalSymbols, duration, extraSymbols) {
                const currentVisible = this.symbols.slice(0, 3);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ (3 –∏–ª–∏ 30)
                const filler = this.generateRandomSet(extraSymbols);
                const fullStrip = [...finalSymbols, ...filler, ...currentVisible];
                
                this.renderStrip(fullStrip);
                
                const startY = -((fullStrip.length - 3) * this.SYMBOL_HEIGHT);
                
                this.el.style.transition = 'none';
                this.el.style.transform = `translateY(${startY}px)`;
                this.el.offsetHeight; 

                this.el.style.transition = `transform ${duration}ms cubic-bezier(0.5, 0, 0.3, 1.15)`;
                this.el.style.transform = `translateY(0px)`;

                return new Promise(resolve => {
                    setTimeout(() => {
                        AudioSys.stop();
                        resolve();
                    }, duration);
                });
            }
        }

        class SlotMachine {
            constructor() {
                this.balance = parseInt(localStorage.getItem('jigu_bal')) || 1000;
                this.betPerLine = 20;
                this.lines = 5;
                this.isSpinning = false;
                this.auto = false;
                this.previewTimeout = null;
                
                this.ui = {
                    bal: document.getElementById('ui-balance'),
                    win: document.getElementById('ui-win'),
                    bet: document.getElementById('ui-bet'),
                    total: document.getElementById('ui-total-bet'),
                    status: document.getElementById('status-text'),
                    btnSpin: document.getElementById('btn-spin'),
                    btnAuto: document.getElementById('btn-auto'),
                    svg: document.getElementById('paylines-svg'),
                    modal: document.getElementById('win-modal'),
                    modalAmt: document.getElementById('modal-win-amount'),
                    legend: document.getElementById('legend-grid')
                };

                this.reels = [];
                this.setupReels();
                this.renderLegend();
                this.updateUI();
                this.updateLineButtons();
            }

            setupReels() {
                const container = document.getElementById('slot-machine');
                for(let i=0; i<3; i++) {
                    const col = document.createElement('div');
                    col.className = 'reel-col';
                    container.appendChild(col);
                    const reel = new Reel(col, i);
                    reel.init();
                    this.reels.push(reel);
                }
            }

            renderLegend() {
                this.ui.legend.innerHTML = '';
                ASSETS.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'bg-slate-800/50 rounded p-2 flex flex-col items-center justify-center border border-white/5';
                    el.innerHTML = `
                        <div class="w-8 h-8 mb-1 flex items-center justify-center">
                            <img src="${item.img}" onerror="this.style.display='none'; this.parentNode.innerText='${item.val}'" class="w-full h-full object-contain drop-shadow">
                        </div>
                        <span class="text-xs font-bold text-yellow-400">x${item.payout}</span>
                    `;
                    this.ui.legend.appendChild(el);
                });
            }

            resetBalance() {
                if(this.balance < 100) {
                    if(confirm("–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –¥–æ 1000?")) {
                        this.balance = 1000;
                        this.updateUI();
                        AudioSys.playTone(800, 'sine', 0.1);
                    }
                } else {
                    alert("–ë–∞–ª–∞–Ω—Å –º–æ–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å, –∫–æ–≥–¥–∞ –æ–Ω –æ–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∏–∂–µ 100.");
                }
            }

            adjustBet(delta) {
                if(this.isSpinning) return;
                const newBet = this.betPerLine + delta;
                if(newBet >= 10 && newBet <= 500) {
                    this.betPerLine = newBet;
                    this.updateUI();
                    AudioSys.playTone(600, 'sine', 0.05);
                }
            }

            setLines(n) {
                if(this.isSpinning) return;
                this.lines = n;
                this.updateUI();
                this.updateLineButtons();
                this.drawLinesPreview();
                AudioSys.playTone(600, 'sine', 0.05);
            }

            updateLineButtons() {
                const btns = document.querySelectorAll('#lines-control-panel button');
                btns.forEach(btn => {
                    const val = parseInt(btn.innerText);
                    if (val === this.lines) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }

            toggleAuto() {
                this.auto = !this.auto;
                this.ui.btnAuto.classList.toggle('active-auto', this.auto);
                if(this.auto && !this.isSpinning) this.spin();
            }

            getTotalBet() { return this.betPerLine * this.lines; }

            updateUI() {
                this.ui.bal.innerText = this.balance;
                this.ui.bet.innerText = this.betPerLine;
                this.ui.total.innerText = this.getTotalBet();
                localStorage.setItem('jigu_bal', this.balance);
                
                if(this.balance < this.getTotalBet()) {
                    this.ui.total.classList.add('text-red-500');
                    this.ui.status.innerHTML = "<span class='text-red-400'>–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤</span>";
                } else {
                    this.ui.total.classList.remove('text-red-500');
                    this.ui.status.innerText = this.isSpinning ? "–ö—Ä—É—Ç–∏–º..." : "–£–¥–∞—á–∏!";
                }
            }

            drawLinesPreview() {
                if (this.previewTimeout) clearTimeout(this.previewTimeout);
                this.ui.svg.innerHTML = '';
                for(let i=0; i<this.lines; i++) { this.drawLine(i); }
                this.previewTimeout = setTimeout(() => {
                    if (!this.isSpinning) this.ui.svg.innerHTML = '';
                }, 2000);
            }

            drawLine(lineIdx) {
                if(!LINES_MAP[lineIdx]) return;
                const cfg = LINES_MAP[lineIdx];
                const path = cfg.path; 
                const getCoord = (c, r) => `${(c*33.33)+16.66} ${(r*33.33)+16.66}`;
                const d = `M ${getCoord(0, path[0])} L ${getCoord(1, path[1])} L ${getCoord(2, path[2])}`;
                const el = document.createElementNS("http://www.w3.org/2000/svg", "path");
                el.setAttribute("d", d);
                el.setAttribute("stroke", cfg.color);
                el.setAttribute("class", "payline-path");
                this.ui.svg.appendChild(el);
            }

            getResults() {
                let grid = [];
                
                // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –±–∞—Ä–∞–±–∞–Ω (–±–µ–∑ –±—É—Å—Ç–æ–≤, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–∞–Ω–¥–æ–º)
                grid[0] = this.reels[0].generateRandomSet(3);

                // 2. –°–æ–±–∏—Ä–∞–µ–º ID —Å–∏–º–≤–æ–ª–æ–≤, –≤—ã–ø–∞–≤—à–∏—Ö –Ω–∞ 1 –±–∞—Ä–∞–±–∞–Ω–µ
                const idsFromReel1 = grid[0].map(s => s.id);
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ç–æ—Ä–æ–π –±–∞—Ä–∞–±–∞–Ω, –ø–µ—Ä–µ–¥–∞–≤–∞—è —ç—Ç–∏ ID –¥–ª—è –±—É—Å—Ç–∞
                grid[1] = this.reels[1].generateRandomSet(3, idsFromReel1);

                // 3. –°–æ–±–∏—Ä–∞–µ–º ID —Å–∏–º–≤–æ–ª–æ–≤, –≤—ã–ø–∞–≤—à–∏—Ö –Ω–∞ 2 –±–∞—Ä–∞–±–∞–Ω–µ
                // –õ–æ–≥–∏–∫–∞: —Å–∏–º–≤–æ–ª —Å–æ 2 –±–∞—Ä–∞–±–∞–Ω–∞ –∏–º–µ–µ—Ç —à–∞–Ω—Å "–ø–µ—Ä–µ—Ç–µ—á—å" –Ω–∞ 3
                const idsFromReel2 = grid[1].map(s => s.id);
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç—Ä–µ—Ç–∏–π –±–∞—Ä–∞–±–∞–Ω —Å –±—É—Å—Ç–æ–º –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ
                grid[2] = this.reels[2].generateRandomSet(3, idsFromReel2);

                return grid;
            }

            async spin() {
                const cost = this.getTotalBet();
                if(this.isSpinning || this.balance < cost) {
                    if(this.auto && this.balance < cost) this.toggleAuto();
                    return;
                }

                this.isSpinning = true;
                this.balance -= cost;
                this.ui.win.innerText = "0";
                this.ui.svg.innerHTML = '';
                if(this.previewTimeout) clearTimeout(this.previewTimeout);
                
                this.ui.btnSpin.disabled = true;
                
                document.querySelectorAll('.win-pulse').forEach(el => el.classList.remove('win-pulse'));
                this.updateUI();
                
                const resultGrid = this.getResults(); 

                // --- ANTICIPATION LOGIC ---
                let anticipate = false;
                for(let lineIdx=0; lineIdx < this.lines; lineIdx++) {
                    const path = LINES_MAP[lineIdx].path;
                    // –ö–æ—Ä–æ–Ω–∞ - —ç—Ç–æ ID 8
                    if(resultGrid[0][path[0]].id === 8 && resultGrid[1][path[1]].id === 8) {
                        anticipate = true;
                        break;
                    }
                }

                const promises = this.reels.map((reel, i) => {
                    const delay = i * 200; 
                    let duration = 1000;
                    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ —Å–∏–º–≤–æ–ª–æ–≤
                    let extraSymbols = 2; 

                    // –ï—Å–ª–∏ 3-–π –±–∞—Ä–∞–±–∞–Ω –∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ –∫–æ—Ä–æ–Ω—ã
                    if(i === 2 && anticipate) {
                        duration += 2000; // –î–æ–ª–≥–æ
                        extraSymbols = 20; // –ú–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                    }

                    return new Promise(r => setTimeout(() => {
                        AudioSys.spin();
                        reel.spin(resultGrid[i], duration, extraSymbols).then(r);
                    }, delay));
                });

                await Promise.all(promises);

                this.checkWin(resultGrid);
                
                this.isSpinning = false;
                this.ui.btnSpin.disabled = false;
                this.updateUI();

                if(this.auto) setTimeout(() => this.spin(), 100);
            }

            checkWin(grid) {
                let totalWin = 0;
                let winLinesIndices = [];

                for(let i=0; i<this.lines; i++) {
                    const lineCfg = LINES_MAP[i];
                    if(!lineCfg) continue;
                    const p = lineCfg.path; 
                    
                    const s1 = grid[0][p[0]];
                    const s2 = grid[1][p[1]];
                    const s3 = grid[2][p[2]];

                    if(s1.id === s2.id && s2.id === s3.id) {
                        const pay = this.betPerLine * s1.payout;
                        totalWin += pay;
                        winLinesIndices.push(i);
                        
                        this.highlightSymbol(0, p[0]);
                        this.highlightSymbol(1, p[1]);
                        this.highlightSymbol(2, p[2]);
                    }
                }

                if(totalWin > 0) {
                    this.balance += totalWin;
                    this.ui.win.innerText = totalWin;
                    this.ui.status.innerHTML = `<span class="text-yellow-400 font-bold animate-pulse">–í–´–ò–ì–†–´–®: ${totalWin}!</span>`;
                    AudioSys.win();
                    winLinesIndices.forEach(idx => this.drawLine(idx));
                    this.showFloatingText(`+${totalWin}`);
                    if(totalWin >= this.getTotalBet() * 10) this.celebrateBigWin(totalWin);
                }
            }

            highlightSymbol(colIdx, rowIdx) {
                const col = this.reels[colIdx].el;
                const symbols = col.children;
                if(symbols[rowIdx]) symbols[rowIdx].classList.add('win-pulse');
            }

            showFloatingText(txt) {
                const el = document.createElement('div');
                el.className = 'float-text';
                el.innerText = txt;
                document.getElementById('game-wrapper').appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }

            celebrateBigWin(amount) {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fbbf24', '#ef4444', '#3b82f6'] });
                this.ui.modalAmt.innerText = amount;
                this.ui.modal.classList.remove('hidden');
            }
        }

        window.game = new SlotMachine();
    </script>
</body>
</html>
